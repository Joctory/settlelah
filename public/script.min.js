function getAccessToken(){return localStorage.getItem("settlelah_access_token")}function getRefreshToken(){return localStorage.getItem("settlelah_refresh_token")}function getLegacyToken(){return localStorage.getItem("settlelah_user_token")}function clearAuthTokens(){localStorage.removeItem("settlelah_access_token"),localStorage.removeItem("settlelah_refresh_token"),localStorage.removeItem("settlelah_user_token"),localStorage.removeItem("settlelah_authenticated"),localStorage.removeItem("settlelah_auth_expiry"),localStorage.removeItem("settlelah_user_id"),localStorage.removeItem("settlelah_user_name"),localStorage.removeItem("settlelah_user_email")}function isTokenExpired(e){if(!e)return!0;try{const t=JSON.parse(atob(e.split(".")[1])),n=Date.now()/1e3;return t.exp<n}catch(e){return console.error("Error parsing token:",e),!0}}async function refreshAccessToken(){const e=getRefreshToken();if(!e||isTokenExpired(e))return console.log("No valid refresh token available"),null;try{const t=await fetch("/api/refresh-token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(t.ok){const e=await t.json();return localStorage.setItem("settlelah_access_token",e.accessToken),e.accessToken}return console.error("Token refresh failed:",await t.text()),null}catch(e){return console.error("Error refreshing token:",e),null}}function checkAuthentication(){const e=getAccessToken(),t=getRefreshToken(),n="true"===localStorage.getItem("settlelah_authenticated"),o=parseInt(localStorage.getItem("settlelah_auth_expiry")||"0");return!(!e||isTokenExpired(e))||(t&&!isTokenExpired(t)?(refreshAccessToken().then(e=>{e||(clearAuthTokens(),window.location.href="/login")}),!0):!!(n&&o>Date.now())||(clearAuthTokens(),window.location.href="/login",!1))}function getUserId(){return localStorage.getItem("settlelah_user_id")}async function fetchWithUserId(e,t={}){const n=getUserId();t.headers||(t.headers={}),n&&(t.headers["x-user-id"]=n);let o=getAccessToken();if(o&&!isTokenExpired(o)||(o=await refreshAccessToken()),o)t.headers.Authorization=`Bearer ${o}`;else{const e=getLegacyToken();e&&(t.headers.Authorization=`Bearer ${e}`)}const a=await fetch(e,t);if(401===a.status&&o){const n=await refreshAccessToken();if(n)return t.headers.Authorization=`Bearer ${n}`,fetch(e,t);clearAuthTokens(),window.location.href="/login"}return a}function initializePullToRefresh(){let e=0,t=0;const n=document.querySelector(".pull-to-refresh"),o=document.querySelector(".pull-to-refresh-text"),a=[document.getElementById("homeContainer"),document.getElementById("historyContainer"),document.getElementById("settingsContainer")];if(!n)return;a.forEach(a=>(a=>{a&&(a.addEventListener("touchstart",t=>{0===a.scrollTop&&(e=t.touches[0].screenY)},{passive:!0}),a.addEventListener("touchmove",s=>{if(0===e)return;t=s.touches[0].screenY;const r=t-e;if(r>0&&0===a.scrollTop){const e=40*Math.min(r/80,1);n.classList.add("visible"),n.style.transform=`translateY(${e}px)`,o.textContent=r>=80?"Release to refresh":"Pull down to refresh",r>30&&s.preventDefault()}},{passive:!1}),a.addEventListener("touchend",a=>{if(t-e>=80){n.style.transform="translateY(40px)",o.textContent="Refreshing...";const e=document.querySelector(".pull-to-refresh-spinner");e.style.animation="spin 1s infinite linear",navigator.vibrate&&navigator.vibrate(30),refreshCurrentPage(),setTimeout(()=>{n.style.transform="translateY(0)",n.style.opacity="0.5",setTimeout(()=>{n.classList.remove("visible"),n.style.transform="translateY(-100%)",n.style.opacity="1",e.style.animation=""},500)},1500)}else n.style.transform="translateY(0)",n.style.opacity="0.5",setTimeout(()=>{n.classList.remove("visible"),n.style.transform="translateY(-100%)",n.style.opacity="1"},500);e=0,t=0},{passive:!1}))})(a))}async function refreshCurrentPage(){"home"===activePage?(await updateHomePageCards(),updateLastSettle(),fetchWeatherData()):"history"===activePage&&fetchHistory()}function extendAuthSession(){if("true"===localStorage.getItem("settlelah_authenticated")){const e=Date.now()+1296e6;localStorage.setItem("settlelah_auth_expiry",e.toString())}}function logout(){confirm("Are you sure you want to log out?")&&(clearAuthTokens(),localStorage.removeItem("groups"),groups={},showToast("logoutToast"),setTimeout(()=>{window.location.href="/login"},500))}document.addEventListener("touchstart",function(e){e.touches.length>1&&(e.preventDefault(),e.stopPropagation())},{passive:!1}),document.addEventListener("gesturestart",function(e){e.preventDefault()},{passive:!1}),window.location.pathname.startsWith("/result")||checkAuthentication(),document.addEventListener("click",extendAuthSession),document.addEventListener("keydown",extendAuthSession);let dishes=[],members=[],currentStep=1,groups=JSON.parse(localStorage.getItem("groups"))||{},currentGroup="";const editMode=!1;let editingIndex=-1;const settleChoiceError=document.querySelector(".settle-choice-error"),savedGroupError=document.querySelector(".saved-group-error");let currentActiveBubble=2,activePage="home";const pageContainers={1:"historyContainer",2:"homeContainer",3:"settingsContainer"};let currentSettleView="settleChoiceView",previousView="",isEditingGroup=!1,birthdayPerson=null;function showError(e){document.getElementById("error").textContent=e}function clearError(){const e=document.getElementById("error");e&&(e.textContent="")}function switchPage(e){Object.values(pageContainers).forEach(e=>{const t=document.getElementById(e);t&&(t.classList.remove("active"),t.classList.add("inactive"))});const t=document.getElementById(pageContainers[e]);t&&(t.classList.remove("inactive"),t.classList.add("active"),activePage=pageContainers[e].replace("Container",""),1===e&&fetchHistory())}function showStep(e){document.querySelectorAll(".step").forEach(e=>e.style.display="none"),document.getElementById(`step${e}`).style.display="block",currentStep=e,clearError()}function scanReceipt(){const e=document.getElementById("receiptImage"),t=document.getElementById("scanReceiptBtn"),n=document.querySelector(".scan-receipt-error-message"),o=document.querySelector(".scan-receipt-overlay"),a=e.files[0];if(!a)return n.textContent="Please select a receipt image to scan.",void(n.style.display="block");n.textContent="",n.style.display="none";if(a.size>10485760)return n.textContent="File size exceeds 10MB limit. Please upload a smaller file.",void(n.style.display="block");n.textContent="",n.style.display="none",o&&o.classList.add("active"),t.disabled=!0,t.textContent="Processing...";const s=new FormData;s.append("document",a),fetchWithUserId("/api/scan-receipt",{method:"POST",body:s}).then(e=>e.ok?e.json():e.text().then(t=>{throw new Error(`HTTP error ${e.status}: ${t}`)})).then(e=>{if(!e.success||!e.dishes)throw new Error("Invalid response data");const t=e.dishes;dishes||(dishes=[]),dishes=dishes.concat(t);const n=document.querySelector(".scan-item-btn");n&&(n.style.display="none"),updateDishSummary();const o=document.querySelector(".toast-count");o&&(o.textContent=`${t.length} item${1!==t.length?"s":""} added`)}).catch(e=>{console.error("Error scanning receipt:",e),window.scanErrorMessage=e.message}).finally(()=>{setTimeout(()=>{const e=document.querySelector(".scanning-text");e&&(window.scanErrorMessage?(e.textContent="Scan failed!",e.style.animation="none",e.style.color="#ff4c4c"):(e.textContent="Scanning complete!",e.style.animation="none",e.style.color="#4cff4c")),setTimeout(()=>{o&&(hideModal("scanReceiptModal"),setTimeout(()=>{if(o.classList.remove("active"),o.style.transition="",o.style.opacity="",e&&(e.textContent="Scanning your receipt...",e.style.animation="",e.style.color=""),window.scanErrorMessage){showToast("scanErrorToast");const e=document.getElementById("scanErrorToast");if(e){const t=e.querySelector(".toast-error-message");t&&(t.textContent=window.scanErrorMessage||"Unable to process receipt");const n=e.querySelector(".try-again-btn");n&&(n.onclick=function(){resetScanningOverlay(),showModal("scanReceiptModal"),e.classList.remove("show")}),window.scanErrorMessage=null}}else{showSummary("fully-open"),showToast("scanSuccessToast");const e=document.getElementById("scanSuccessToast");if(e){const t=e.querySelector(".view-items-btn");t&&(t.onclick=function(){showSummary("fully-open"),e.classList.remove("show")})}}o.style.transition="opacity 0.5s ease",o.style.opacity="0"},500))},1e3),t.disabled=!1,t.textContent="Scan Receipt"},2e3)})}function editDish(e){const t=dishes[e];document.getElementById("itemName").value=t.name,document.getElementById("itemPrice").value=t.cost;const n=document.getElementById("assignedMembers");n.innerHTML="",t.members.forEach(e=>{let t,o;if("object"==typeof e&&e.name)t=e.name,o=e.avatar;else{t=e;let n=!1;const a=JSON.parse(localStorage.getItem("groups"))||{};if(Object.values(a).forEach(e=>{e.forEach(e=>{"object"==typeof e&&e.name===t&&e.avatar&&(o=e.avatar,n=!0)})}),!n){const e=t.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);o=Math.abs(e%20)+1}}const a=document.createElement("div");a.className="member-avatar-wrapper sortable-item",a.dataset.name=t;const s=document.createElement("div");s.className="member-avatar";const r=document.createElement("img");r.src=`assets/cat-icon/cat-${o}.svg`,r.alt=`Cat avatar ${t}`,r.className="cat-avatar-img",s.appendChild(r);const i=document.createElement("div");i.className="member-name",i.textContent=t,a.appendChild(s),a.appendChild(i),a.ondblclick=()=>a.remove(),n.appendChild(a)}),deleteDish(e),updateDishList(),clearError(),closeBillSummaryModal(),setTimeout(()=>{const e=document.getElementById("billSummaryModal");e.classList.remove("fully-open","half-open"),e.classList.add("peeking")},50)}function deleteDish(e,t=!1){dishes.splice(e,1);if(document.getElementById("dishList")&&updateDishList(),updateDishSummary(),0===dishes.length){const e=document.getElementById("next3");e&&(e.disabled=!0),closeSummary()}else t||showSummary()}function updateDishList(){const e=document.getElementById("dishList");if(!e)return;e.innerHTML="",dishes.forEach((t,n)=>{const o=document.createElement("li");o.innerHTML=`${t.name}: $${t.cost.toFixed(2)} (split: ${t.members.join(", ")}) \n      <button onclick="editDish(${n})">Edit</button>\n      <button onclick="deleteDish(${n})">Delete</button>`,e.appendChild(o)});const t=dishes.reduce((e,t)=>e+t.cost,0),n=document.getElementById("summaryTotal");n&&(n.textContent=`Total Dishes Cost: $${t.toFixed(2)}`)}function showSummary(e="fully-open"){updateDishSummary();document.getElementById("billSummaryOverlay").classList.add("active");const t=document.getElementById("billSummaryModal");t.style.display="block",setTimeout(()=>{t.classList.remove("peeking","half-open","fully-open"),t.classList.add(e)},10)}function closeSummary(){const e=document.getElementById("billSummaryModal");e.classList.remove("fully-open","half-open"),e.classList.add("peeking");document.getElementById("billSummaryOverlay").classList.remove("active")}function toggleBillSummaryVisibility(e){const t=document.getElementById("billSummaryModal"),n=document.getElementById("billSummaryOverlay");e?(t.style.display="block","finaliseSettleBillScreen"===currentSettleView?(t.classList.add("is-finalise-bill"),t.classList.contains("fully-open")||t.classList.contains("half-open")||t.classList.add("peeking"),document.querySelector(".bill-summary-footer").style.display="none"):(t.classList.add("peeking"),t.classList.remove("fully-open","half-open"),document.querySelector(".bill-summary-footer").style.display="flex",t.classList.remove("is-finalise-bill")),n.classList.remove("active")):(t.classList.remove("peeking","half-open","fully-open"),n.classList.remove("active"))}function updateDishSummary(){const e=document.getElementById("dishSummaryContainer");if(!e)return;if(e.innerHTML="",!dishes||0===dishes.length){showToast("noItemsAddedToast");const e=document.getElementById("billSubtotal");e&&(e.textContent="$0.00");const t=document.getElementById("billItemCount");t&&(t.textContent="0");const n=document.querySelector(".confirm-bill-btn");return void(n&&(n.disabled=!0))}dishes.forEach((t,n)=>{const o=document.createElement("div");o.className="dish-summary-item";const a=document.createElement("div");a.className="dish-header";const s=document.createElement("p");s.className="dish-name",s.textContent=t.name;const r=document.createElement("p");r.className="dish-price",r.textContent=`$${parseFloat(t.cost).toFixed(2)}`,a.appendChild(s),a.appendChild(r);const i=document.createElement("div");i.className="dish-members-divider";const l=document.createElement("span");l.textContent=`Split Among (${t.members.length})`,i.appendChild(l);const c=document.createElement("div");c.className="dish-members",t.members.forEach(e=>{const t=document.createElement("div");t.className="dish-member-pill";const n="object"==typeof e?e.name:e;t.textContent=n,c.appendChild(t)});const d=document.createElement("div");d.className="dish-actions";const m=document.createElement("button");m.className="dish-action-btn",m.innerHTML='<img class="group-action-btn-img" src="assets/edit.svg" alt="Edit" />',m.onclick=()=>editDish(n);const u=document.createElement("button");u.className="dish-action-btn",u.innerHTML='<img class="group-action-btn-img" src="assets/bin.svg" alt="Delete" />',u.onclick=()=>deleteDish(n,!0),d.appendChild(m),d.appendChild(u),a.appendChild(d),o.appendChild(a),o.appendChild(i),o.appendChild(c),e.appendChild(o)});const t=dishes.reduce((e,t)=>e+parseFloat(t.cost),0),n=document.getElementById("billSubtotal");n&&(n.textContent=`$${t.toFixed(2)}`);const o=dishes.length,a=document.getElementById("billItemCount");a&&(a.textContent=o.toString());const s=document.querySelector(".confirm-bill-btn");s&&(s.disabled=!1,s.onclick=function(){const e=dishes.filter(e=>!e.members||0===e.members.length);if(e.length>0){const t=document.getElementById("missingMembersToast");if(t){const n=t.querySelector(".toast-error-message");n&&(n.textContent=`${e.length} item${1!==e.length?"s":""} ${1!==e.length?"have":"has"} no members assigned`),showToast("missingMembersToast")}return}showFinaliseSettleBillScreen()});const r=document.querySelector(".add-more-items-btn");r&&(r.onclick=function(){const e=document.getElementById("billSummaryModal"),t=document.getElementById("billSummaryOverlay");e&&(e.style.display="block",e.classList.remove("fully-open","half-open"),e.classList.add("peeking"),t&&t.classList.remove("active"));const n=document.querySelector(".add-settle-item-container");n&&setTimeout(()=>{n.scrollTo({top:0,behavior:"smooth"})},100)})}function showFinaliseSettleBillScreen(){document.getElementById("settleEqually").checked=!1,showSettleView("finaliseSettleBillScreen");const e=document.getElementById("addSettleItemView");e&&e.classList.remove("active");const t=document.getElementById("settleNowScreen");t&&(t.classList.add("active"),t.classList.remove("inactive"));const n=document.getElementById("billSummaryModal"),o=document.getElementById("billSummaryOverlay");n&&(n.style.display="block",n.classList.remove("fully-open","half-open"),n.classList.add("peeking"),o&&o.classList.remove("active"));const a=document.getElementById("finaliseSettleBillScreen");a&&(a.classList.remove("inactive"),a.classList.add("active")),setupPaynowMemberSelection();const s=a.querySelector(".settle-lah-btn");s&&(s.onclick=function(){!function(){const e=document.getElementById("paynowName").value.trim(),t=document.getElementById("paynowPhone").value.trim();let a=!0;const s=document.getElementById("paynowNameError");e?(s.style.display="none",document.getElementById("paynowName").classList.remove("error")):(s.style.display="block",document.getElementById("paynowName").classList.add("error"),a=!1);const r=document.getElementById("paynowPhoneError");t?(r.style.display="none",document.getElementById("paynowPhone").classList.remove("error")):(r.style.display="block",document.getElementById("paynowPhone").classList.add("error"),a=!1);if(!a)return;n&&(n.style.display="none",o&&o.classList.remove("active"));resetLoadingAnimation(),showSettleView("loadingScreen");const i=document.querySelector(".loading-bar");let l=0;const c=setInterval(()=>{l+=1,l>90&&(l=90,clearInterval(c)),i.style.width=l+"%"},100),d=document.getElementById("settleMatter").value||"No one ask!",m=document.getElementById("taxProfile").value,u=document.getElementById("discountValue").value||"0",p=document.getElementById("serviceChargeCheckbox").checked,y=document.getElementById("gstCheckbox").checked,h=document.getElementById("paynowName").value,g=document.getElementById("paynowPhone").value,v=document.getElementById("serviceChargeValue").value||"10",b={members:members,settleMatter:d,dishes:dishes,discount:u,applyServiceCharge:p,applyGst:y,taxProfile:m,paynowName:h,paynowID:g,serviceChargeValue:v,birthdayPerson:birthdayPerson};fetchWithUserId("/calculate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)}).then(e=>e.json()).then(e=>{const t={settleMatter:e.billData.settleMatter,dateString:new Date(e.billData.timestamp).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),timeString:new Date(e.billData.timestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}).replace(" ",""),itemCount:e.billData.dishes.length,subtotal:`$${e.billData.breakdown.subtotal.toFixed(2)}`,serviceCharge:`$${e.billData.breakdown.serviceCharge.toFixed(2)}`,serviceChargeRate:e.billData.serviceChargeRate||"10%",afterService:`$${e.billData.breakdown.afterService.toFixed(2)}`,discount:`$${e.billData.breakdown.discountAmount.toFixed(2)}`,discountInput:e.billData.discount||"",afterDiscount:`$${e.billData.breakdown.afterDiscount.toFixed(2)}`,gst:`$${e.billData.breakdown.gst.toFixed(2)}`,gstRate:e.billData.gstRate||"9%",totalAmount:`$${e.billData.breakdown.total.toFixed(2)}`,payer:e.billData.payer||{name:e.billData.paynowName}},n=document.getElementById("loadingReceipt"),o=document.getElementById("successReceipt");updateReceiptDetails(n,t),updateReceiptDetails(o,t),document.getElementById("shareOptionList").innerHTML=`\n      <div class="share-buttons">\n                <a\n                  id="shareWhatsappBtn"\n                  class="share-btn"\n                  href="https://wa.me/?text=Let%27s%20settle%20our%20bill%20on%20SettleLah!%20${e.link}"\n                  target="_blank"\n                >\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg" alt="WhatsApp" />\n                  <span class="share-btn-span">WhatsApp</span>\n                </a>\n\n                <a\n                  id="shareFacebookBtn"\n                  class="share-btn"\n                  href="https://www.facebook.com/sharer/sharer.php?u=${e.link}"\n                  target="_blank"\n                >\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/facebook.svg" alt="Facebook" />\n                  <span class="share-btn-span">Facebook</span>\n                </a>\n\n                <a\n                  id="shareTwitterBtn"\n                    class="share-btn"\n                  href="https://twitter.com/intent/tweet?text=Let%27s%20settle%20our%20bill%20on%20SettleLah!&url=${e.link}"\n                  target="_blank"\n                >\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/twitter.svg" alt="Twitter" />\n                  <span class="share-btn-span">Twitter</span>\n                </a>\n\n                <a\n                  id="shareLinkedinBtn"\n                  class="share-btn"\n                  href="https://www.linkedin.com/sharing/share-offsite/?url=${e.link}"\n                  target="_blank"\n                >\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linkedin.svg" alt="LinkedIn" />\n                  <span class="share-btn-span">LinkedIn</span>\n                </a>\n\n                <a\n                  id="shareTelegramBtn"\n                  class="share-btn"\n                  href="https://t.me/share/url?url=${e.link}&text=Let%27s%20settle%20our%20bill%20on%20SettleLah!"\n                  target="_blank"\n                >\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg" alt="Telegram" />\n                  <span class="share-btn-span">Telegram</span>\n                </a>\n\n                <a\n                  id="shareEmailBtn"\n                  class="share-btn"\n                  href="mailto:?subject=Let%27s%20settle%20our%20bill%20on%20SettleLah!&body=Here%27s%20the%20link%20to%20our%20bill:%20${e.link}"\n                  target="_blank"\n                >\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/maildotru.svg" alt="Email" />\n                  <span class="share-btn-span">Email</span>\n                </a>\n\n                <a\n                  id="shareSmsBtn"\n                  class="share-btn"\n                  href="sms:?&body=Let%27s%20settle%20our%20bill%20on%20SettleLah!%20${e.link}"\n                >\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/signal.svg" alt="SMS" />\n                  <span class="share-btn-span">SMS</span>\n                </a>\n\n                <button class="share-btn" onclick="copyToClipboard('Lets Settle Our Bill On SettleLah! ${e.link}')">\n                  <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linktree.svg" alt="Copy" />\n                  <span class="share-btn-span">Copy Link</span>\n                </button>\n              </div>\n      `;document.querySelector(".reveal-bill-btn").onclick=function(){window.open(e.link,"_blank"),window.location.href="/"};const a=setInterval(()=>{l+=5,i.style.width=l+"%",document.getElementById("loadingReceipt").classList.add("received"),l>=100&&(clearInterval(a),setTimeout(function(){document.getElementById("loadingReceipt").classList.add("finished"),setTimeout(function(){showSettleView("successScreen")},1e3)},5e3))},100);addBillToHistory(e.id,e.billData)}).catch(e=>{clearInterval(c),showError("Error calculating bill. Please try again.")})}()});const r=document.getElementById("discountValue");r&&r.addEventListener("blur",function(){let e=r.value;e=e.replace(/[a-zA-Z]+/g,"");const t=e.match(/%/g);t&&t.length>1&&(e=e.replace(/%/g,""),e+="%"),r.value=e});const i=document.getElementById("serviceChargeValue"),l=document.querySelector('label[for="serviceChargeCheckbox"]');i&&l&&i.addEventListener("input",function(){})}function populatePaynowNameSelect(){const e=document.getElementById("paynowNameSelect");for(;e.options.length>2;)e.remove(2);members&&members.length>0&&members.forEach(t=>{const n=document.createElement("option");n.value=t.name,n.textContent=t.name,e.appendChild(n)})}function setupPaynowNameSelection(){setupPaynowMemberSelection()}function showPaynowMemberModal(){showModal("paynowMemberModal");const e=document.getElementById("paynowMembersList"),t=document.getElementById("customPaynowName"),n=document.getElementById("paynowName"),o=document.querySelector(".paynow-name-selection"),a=document.getElementById("selectPaynowMemberBtn"),s=document.getElementById("groupMembers"),r=document.getElementById("confirmPaynowMemberBtn");e.innerHTML="",t.value="";s.querySelectorAll(".member-avatar-wrapper").forEach(t=>{const o=t.getAttribute("data-name"),a=t.querySelector(".cat-avatar-img").src,s=document.createElement("div");s.className="member-avatar-wrapper",s.setAttribute("data-name",o),n.value===o&&s.classList.add("selected"),s.innerHTML=`\n      <div class="member-avatar">\n        <img src="${a}" alt="Cat avatar" class="cat-avatar-img">\n      </div>\n      <div class="member-name">${o}</div>\n    `,s.addEventListener("click",()=>{document.querySelectorAll("#paynowMembersList .member-avatar-wrapper").forEach(e=>e.classList.remove("selected")),s.classList.add("selected")}),e.appendChild(s)}),t.addEventListener("input",()=>{document.querySelectorAll("#paynowMembersList .member-avatar-wrapper").forEach(e=>e.classList.remove("selected"))}),r.addEventListener("click",()=>{let s="";const r=e.querySelector(".member-avatar-wrapper.selected");r?(s=r.getAttribute("data-name"),o.classList.add("member-selected")):t.value.trim()&&(s=t.value.trim(),o.classList.remove("member-selected")),s&&(n.value=s,a.querySelector(".btn-text").textContent=s,closePaynowMemberModal())})}function closePaynowMemberModal(){hideModal("paynowMemberModal")}function setupPaynowMemberSelection(){const e=document.getElementById("selectPaynowMemberBtn"),t=document.getElementById("paynowMemberModal").querySelector(".close-modal"),n=document.getElementById("paynowMemberModal").querySelector(".cancel-btn");e.addEventListener("click",()=>{showPaynowMemberModal()}),t.addEventListener("click",closePaynowMemberModal),n.addEventListener("click",closePaynowMemberModal)}function showSuccessScreen(){const e=document.querySelector(".success-footer .avatar-group"),t=window.matchMedia("(min-width: 1100px)").matches;e.innerHTML="";const n=members.slice(0,5),o=members.length>5;if(n.forEach((t,n)=>{const o=document.createElement("div");o.className="avatar";const a=document.createElement("img");let s;if(a.className="avatar-img","object"==typeof t&&t.avatar)s=t.avatar;else{const e="object"==typeof t?t.name:t;let o=!1;const a=JSON.parse(localStorage.getItem("groups"))||{};if(Object.values(a).forEach(t=>{t.forEach(t=>{"object"==typeof t&&t.name===e&&t.avatar&&(s=t.avatar,o=!0)})}),!o)if("object"==typeof t&&t.name){const e=t.name.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);s=Math.abs(e%20)+1}else s=n%20+1}a.src=`assets/cat-icon/cat-${s}.svg`,o.appendChild(a),e.appendChild(o)}),o||0===members.length){if(0===members.length)for(let t=0;t<5;t++){const n=document.createElement("div");n.className="avatar";const o=document.createElement("img");o.className="avatar-img",o.src=`assets/cat-icon/cat-${t+1}.svg`,n.appendChild(o),e.appendChild(n)}const t=document.createTextNode("+");e.appendChild(t)}const a=document.querySelector(".share-bill-btn"),s=document.getElementById("shareBillModal");!s.classList.contains("active")&&t&&s.classList.add("active"),a.onclick=function(){showShareModal()}}function showShareModal(){const e=document.getElementById("shareBillModal"),t=document.getElementById("shareBillOverlay"),n=document.querySelector(".share-close-modal"),o=window.matchMedia("(min-width: 1100px)").matches;e.classList.contains("active")||(e.classList.add("active"),t.classList.add("active")),n&&(n.onclick=closeShareModal),o||(t.onclick=closeShareModal)}function closeShareModal(){const e=document.getElementById("shareBillModal"),t=document.getElementById("shareBillOverlay");e.classList.remove("active"),t.classList.remove("active")}function hideFinaliseSettleBillScreen(){const e=document.getElementById("finaliseSettleBillScreen");e&&(e.classList.remove("active"),e.classList.add("inactive"));const t=document.getElementById("addSettleItemView");t&&t.classList.add("active");const n=document.getElementById("settleNowScreen");n&&(n.classList.remove("inactive"),n.classList.add("active")),showSettleView("addSettleItemView"),showSummary()}function initializeBillSummaryDrag(){const e=document.getElementById("billSummaryModal"),t=document.getElementById("billSummaryOverlay"),n=document.querySelector(".bill-summary-drag-handle");let o=0,a=0,s="peeking",r=!1,i=!1;function l(t){if("mousedown"===t.type&&0!==t.button)return;r=!0,i="mousedown"===t.type,o=t.type.includes("touch")?t.touches[0].clientY:t.clientY;const n=window.getComputedStyle(e);a=parseInt(n.bottom),"mousedown"===t.type&&t.preventDefault()}function c(n){if(!r)return;if("mousemove"===n.type&&!i)return;const s=n.type.includes("touch")?n.touches[0].clientY:n.clientY;let l=a+(o-s);const c=e.offsetHeight;l=Math.min(0,Math.max(100-c,l)),e.style.bottom=`${l}px`;const d=(l+c)/c;t.style.opacity=Math.max(0,Math.min(.5,d)),n.preventDefault()}function d(n){if("mouseup"===n.type&&!i)return;if(!r)return;r=!1,i=!1;const o=window.getComputedStyle(e),a=parseInt(o.bottom),l=e.offsetHeight;a>.25*-l?(e.classList.remove("peeking","half-open"),e.classList.add("fully-open"),s="fully-open",t.classList.add("active")):a>.75*-l?(e.classList.remove("peeking","fully-open"),e.classList.add("half-open"),s="half-open",t.classList.add("active")):(e.classList.remove("fully-open","half-open"),e.classList.add("peeking"),s="peeking",t.classList.remove("active")),e.style.bottom="",t.style.opacity=""}n.addEventListener("touchstart",l),n.addEventListener("touchmove",c),n.addEventListener("touchend",d),n.addEventListener("mousedown",l),document.addEventListener("mousemove",c),document.addEventListener("mouseup",d),t.addEventListener("click",function(){e.classList.remove("fully-open","half-open"),e.classList.add("peeking"),t.classList.remove("active")})}function resetLoadingAnimation(){const e=document.getElementById("loadingScreen").querySelector(".loading-bar");e.style.transition="none",e.style.width="0",e.offsetWidth,e.style.transition="width 2s ease-in-out"}function initializeSwipeGesture(){const e=document.getElementById("bill-summary-handle");if(!e)return;const t={startY:0,startX:0,startTime:0,isProcessingGesture:!1,isScrolling:!1},n=function(e){t.isScrolling=!1,t.isProcessingGesture=!1,t.startY=e.touches[0].clientY,t.startX=e.touches[0].clientX,t.startTime=performance.now()},o=function(e){if(t.isScrolling||t.isProcessingGesture)return;const n=Math.abs(e.touches[0].clientY-t.startY),o=e.currentTarget;n>10&&o.scrollTop>0&&(t.isScrolling=!0)},a=function(e){if(t.isProcessingGesture||t.isScrolling)return;const n=e.changedTouches[0].clientY,o=e.changedTouches[0].clientX,a=performance.now()-t.startTime;if(a<100||a>1300)return;const s=t.startY-n,r=Math.abs(t.startX-o),i=Math.abs(s)/a,l=180*Math.atan2(Math.abs(s),r)/Math.PI;s>80&&i>.6&&l>45&&r<.8*s&&(t.isProcessingGesture=!0,navigator.vibrate&&navigator.vibrate(10),requestAnimationFrame(()=>showSummary("fully-open")),setTimeout(()=>{t.isProcessingGesture=!1},400))},s=function(){t.isProcessingGesture=!1,t.isScrolling=!1},r={passive:!0};var i;(i=e).addEventListener("touchstart",n,r),i.addEventListener("touchmove",o,r),i.addEventListener("touchend",a),i.addEventListener("touchcancel",s),initializeBillSummaryDrag()}function editMember(e){editingIndex=e,document.getElementById("editMemberName").value=members[e],document.getElementById("editMemberPopup").style.display="block"}function saveEditedMember(){const e=document.getElementById("editMemberName"),t=e.value.trim(),n=e.dataset.originalName,o=e.closest(".input-field"),a=o.querySelector(".error-message"),s=document.querySelector(".edit-member-avatar").dataset.avatarNumber;if(!t)return o.classList.add("error"),void a.classList.add("visible");if(members.some(e=>{const o="object"==typeof e?e.name:e;return o===t&&o!==n}))return o.classList.add("error"),a.textContent="This name already exists",void a.classList.add("visible");const r=members.findIndex(e=>"object"==typeof e?e.name===n:e===n);-1!==r&&("string"==typeof members[r]?members[r]={name:t,avatar:s}:members[r].name=t);document.querySelectorAll(".member-item").forEach(e=>{e.dataset.name===n&&(e.dataset.name=t,e.querySelector(".member-name").textContent=t)}),"addSettleItemView"===currentSettleView&&updateSettleItemMembersUI(),hideModal("editMemberModal")}function updateGroupSelect(){const e=document.getElementById("groupSelect");e.innerHTML="",Object.keys(groups).forEach(t=>{const n=document.createElement("label"),o=document.createElement("input");o.type="radio",o.name="group",o.value=t,n.appendChild(o),n.appendChild(document.createTextNode(t)),e.appendChild(n),o.onchange=()=>{document.getElementById("next1").disabled=!o.checked}})}function fetchHistory(){const e=document.querySelector(".history-list"),t=document.querySelector(".history-loading");t&&t.classList.add("active"),e.innerHTML="";for(let t=0;t<3;t++){const t=document.createElement("div");t.className="loading-placeholder",e.appendChild(t)}fetchWithUserId("/api/history",{method:"GET",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()}).then(n=>{setTimeout(()=>{if(t&&t.classList.remove("active"),e.innerHTML="",!n||!n.bills||0===n.bills.length)return e.innerHTML="<p class='no-history'>No history yet.</p>",void(document.getElementById("clearHistoryBtn").style.display="none");document.getElementById("clearHistoryBtn").style.display="block",n.bills.sort((e,t)=>t.timestamp-e.timestamp).forEach(t=>{const n=document.createElement("a");n.href=`/bill/${t.id}`,n.target="_blank",n.className="settle-item";const o=new Date(t.timestamp).toLocaleString(),a=`$${roundToNearest5Cents(t.breakdown?.total||0)}`,s=t.settleMatter||"Settlement",r=t.members||[],i=r.slice(0,5).map(e=>`<div class="avatar">\n                    <img class="avatar-img" src="assets/cat-icon/cat-${e.avatar||1}.svg" />\n                  </div>`).join(""),l=r.length>5?"+":"";n.innerHTML=`\n              <div class="settle-top">\n                <div class="settle-info">\n                  <p class="settle-info-amount">${a}</p>\n                  <p class="settle-info-matter">${s}</p>\n                  <p class="settle-info-group">${r.length} members</p>\n                </div>\n                <div class="settle-delete">\n                  <button class="delete-history-btn" data-bill-id="${t.id}" title="Delete">\n                    <img src="assets/bin.svg" alt="Delete" />\n                  </button>\n                </div>\n              </div>\n              <div class="settle-bottom">\n                <div class="settle-info-date">\n                  <span>${o}</span>\n                </div>\n                <div class="settle-avatar">\n                  <div class="avatar-group">\n                    ${i}\n                    ${l}\n                  </div>\n                </div>\n              </div>\n            `,e.appendChild(n);const c=n.querySelector(".delete-history-btn");c&&c.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();const t=this.getAttribute("data-bill-id");confirm("Are you sure you want to delete this record?")&&deleteHistoryRecord(t,n)})})},800)}).catch(n=>{console.error("Error fetching history:",n),e.innerHTML="<p class='error'>Failed to load history. Please try again later.</p>",t&&t.classList.remove("active")})}function moveWithCalc(e){moveWithClass(e,document.getElementById("navbarContainer").offsetWidth/3*(e-.5)+"px",{1:"theme-history",2:"theme-home",3:"theme-settings"}[e]),switchPage(e)}function handleResize(){currentActiveBubble&&moveWithCalc(currentActiveBubble)}function moveWithClass(e,t,n){currentActiveBubble=e;const o=document.getElementById("navbarContainer"),a=document.getElementById("navbg");for(let e=1;e<=3;e++){const t=document.getElementById(`bubble${e}`),n=document.getElementById(`menu${e}`);t.style.transform="translateY(150%)",t.classList.remove("bubble-bounce"),document.getElementById(`bubble${e}`).querySelector(".icon").style.opacity=0,n.classList.remove("active"),n.style.opacity="0.4"}["theme-history","theme-home","theme-settings"].forEach(e=>{o.classList.remove(e),a.classList.remove(e)}),o.classList.add(n),a.classList.add(n),setTimeout(()=>{const t=document.getElementById(`bubble${e}`);t.style.transform="",t.classList.add("bubble-bounce"),t.querySelector(".icon").style.opacity=.7;document.getElementById(`menu${e}`).classList.add("active")},50)}function toggleDarkMode(){document.body.classList.contains("dark-mode")?(document.body.classList.remove("dark-mode"),localStorage.setItem("darkMode","disabled")):(document.body.classList.add("dark-mode"),localStorage.setItem("darkMode","enabled"))}function updateTaxRates(e){const t=document.getElementById("serviceRate"),n=document.getElementById("gstRate");updateGSTCheckboxLabel(e),updatePaymentLabels(e);const o=document.getElementById("serviceChargeValue")?.value||"10";t.textContent=`${o}%`,"singapore"===e?n.textContent="9%":"malaysia"===e&&(n.textContent="6%")}function updateGSTCheckboxLabel(e){const t=document.querySelector('label[for="gstCheckbox"]');if(t){const n="singapore"===e?"9%":"6%";t.textContent=`Add ${n} GST`}}function updatePaymentLabels(e){const t=document.querySelector('label[for="paynowName"]'),n=document.querySelector('label[for="paynowPhone"]'),o=document.getElementById("paynowName"),a=document.getElementById("paynowPhone"),s=o?.parentElement.querySelector(".helper-text"),r=a?.parentElement.querySelector(".helper-text"),i=document.getElementById("paynowNameError"),l=document.getElementById("paynowPhoneError");t&&n&&("malaysia"===e?(t.textContent="Pay to",n.textContent="Payee Phone Number",o&&(o.placeholder="Enter recipient name"),a&&(a.placeholder="Enter payee phone number",a.removeAttribute("pattern"),a.removeAttribute("title")),s&&(s.textContent="Enter the name of payment recipient"),r&&(r.textContent="Enter the payee phone number"),i&&(i.textContent="Please enter recipient name"),l&&(l.textContent="Please enter a valid phone number")):(t.textContent="PayNow Name",n.textContent="PayNow Phone Number",o&&(o.placeholder="Enter name"),a&&(a.placeholder="Enter phone number (e.g., 8XXX XXXX)",a.setAttribute("pattern","[89]\\d{7}"),a.setAttribute("title","Please enter a valid Singapore phone number starting with 8 or 9, followed by 7 digits")),s&&(s.textContent="Enter the name of PayNow account"),r&&(r.textContent="Enter the payer phone number to generate PayNow QR"),i&&(i.textContent="Please enter PayNow name"),l&&(l.textContent="Please enter a valid PayNow phone number")))}function showSettleNowScreen(){Object.values(pageContainers).forEach(e=>{const t=document.getElementById(e);t&&(t.classList.remove("active"),t.classList.add("inactive"))});const e=document.getElementById("settleNowScreen");e.classList.remove("inactive"),e.classList.add("active");Object.keys(groups).length>0||(document.querySelector(".saved-group-option").style.display="none",document.querySelector(".or-divider").style.display="none",document.querySelector(".new-group-option").classList.add("selected")),showSettleView("settleChoiceView"),document.getElementById("navbarContainer").classList.add("navbar-hidden")}function hideSettleNowScreen(){const e=document.getElementById("settleNowScreen");e.classList.remove("active"),e.classList.add("inactive");const t=document.getElementById("homeContainer");t.classList.remove("inactive"),t.classList.add("active"),document.getElementById("navbarContainer").classList.remove("navbar-hidden");const n=document.getElementById("billSummaryModal");n&&n.classList.remove("peeking","half-open","fully-open");const o=document.getElementById("billSummaryOverlay");o&&o.classList.remove("active"),updateHomePageCards()}function showSettleView(e){document.querySelectorAll(".settle-view").forEach(e=>{e.classList.remove("active")});const t=document.getElementById("finaliseSettleBillScreen");t&&(t.classList.remove("active"),t.classList.add("inactive"));const n=document.getElementById(e);n&&(n.classList.add("active"),currentSettleView=e);const o=document.querySelector(".white-slide-container");"addSettleItemView"===e||"finaliseSettleBillScreen"===e?(o.classList.add("hidden"),toggleBillSummaryVisibility(!0)):(o.classList.remove("hidden"),toggleBillSummaryVisibility(!1));const a=document.getElementById("settleNowScreen");"loadingScreen"===e&&(a.classList.remove("active"),a.classList.add("inactive"));const s=document.getElementById("loadingScreen");"successScreen"===e&&(showSuccessScreen(),setTimeout(()=>{s.classList.remove("active"),s.classList.add("inactive")},2e3)),updateSettleNowHeader()}function updateSettleNowHeader(){const e=document.querySelector(".settle-now-header h1");"settleChoiceView"===currentSettleView?e.textContent="Settle Now?":"newGroupMembersView"===currentSettleView?e.textContent=isEditingGroup?"Edit Group":"Settle Now?":"addSettleItemView"===currentSettleView?e.textContent="Add Settle Item":"savedGroupsView"===currentSettleView?e.textContent="Settle With Saved Group":"finaliseSettleBillScreen"===currentSettleView&&(e.textContent="Finalise Settle Bill");const t=document.getElementById("finaliseSettleBillScreen");if(t&&t.classList.contains("active")){const e=t.querySelector(".settle-now-header h1");e&&(e.textContent="Finalise Settle Bill")}}function handleSettleBackButton(){const e=document.getElementById("billSummaryModal");if("settleChoiceView"===currentSettleView)hideSettleNowScreen(),e&&(e.style.display="none");else if("newGroupMembersView"===currentSettleView)birthdayPerson=null,isEditingGroup?(isEditingGroup=!1,showSettleView("savedGroupsView"),updateSettleNowHeader()):showSettleView("settleChoiceView"),e&&(e.style.display="none");else if("addSettleItemView"===currentSettleView)showModal("backConfirmModal");else if("savedGroupsView"===currentSettleView){birthdayPerson=null;Object.keys(groups).length>0?(document.querySelector(".saved-group-option").style.display="flex",document.querySelector(".or-divider").style.display="flex",document.querySelector(".get-started-btn").disabled=!1,settleChoiceError.style.display="none"):(document.querySelector(".saved-group-option").style.display="none",document.querySelector(".or-divider").style.display="none",document.querySelector(".new-group-option").classList.add("selected")),showSettleView("settleChoiceView"),e&&(e.style.display="none")}else"finaliseSettleBillScreen"===currentSettleView&&hideFinaliseSettleBillScreen()}function loadSavedGroups(){const e=JSON.parse(localStorage.getItem("groups"))||{};groups={...e},showSettleView("savedGroupsView");const t=document.querySelector(".saved-groups-loading");t.classList.add("active"),t.disabled=!0,fetchGroupsFromFirebase().then(()=>{renderSavedGroups()}).catch(e=>{console.error("Error fetching groups from Firebase:",e),renderSavedGroups()}).finally(()=>{t&&(t.classList.remove("active"),t.disabled=!1)})}async function fetchGroupsFromFirebase(){try{const e=await fetchWithUserId("/api/groups");if(!e.ok)throw new Error(`Failed to fetch groups from Firebase: ${e.statusText}`);const t=await e.json();t.groups&&(groups={...groups,...t.groups},localStorage.setItem("groups",JSON.stringify(groups)))}catch(e){throw console.error("Error fetching groups from Firebase:",e),e}}function renderSavedGroups(){const e=Object.keys(groups),t=document.querySelector(".saved-groups-list-container"),n=document.querySelector(".no-saved-groups");t.innerHTML="",0===e.length?(n.style.display="flex",document.querySelector(".saved-groups-next-btn").disabled=!0):(n.style.display="none",document.querySelector(".saved-groups-next-btn").disabled=!1,e.forEach((e,n)=>{const o=createSavedGroupCard(e,groups[e],n);t.appendChild(o)}))}function createSavedGroupCard(e,t,n){const o=document.createElement("div");o.className="saved-group-card",o.dataset.groupName=e;const a=.2+.2*n;o.style.animationDelay=`${a}s`;const s=document.createElement("div");s.className="saved-group-title",s.textContent=e,s.style.animationDelay=`${a+.1}s`;const r=document.createElement("div");r.className="saved-group-members",r.style.animationDelay=`${a+.2}s`;t.forEach((e,t)=>{const n=document.createElement("div");n.className="member-avatar-wrapper",n.style.animationDelay=`${a+.3+.2*t}s`;const o=document.createElement("div");o.className="member-avatar";const s=document.createElement("img");let i,l;if("object"==typeof e&&e.name)i=e.name,l=e.avatar||Math.floor(20*Math.random())+1;else{i=e;const t=i.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);l=Math.abs(t%20)+1}s.src=`assets/cat-icon/cat-${l}.svg`,s.alt=`Cat avatar ${l}`,s.className="cat-avatar-img saved-group-avatar-img",o.appendChild(s),n.appendChild(o);const c=document.createElement("div");c.className="member-name",c.textContent=i,n.appendChild(c),r.appendChild(n)});const i=document.createElement("div");i.className="member-count",i.style.animationDelay=`${a+.6}s`,i.textContent=`${t.length} members`;const l=document.createElement("div");l.className="action-buttons",l.style.animationDelay=`${a+.7}s`;const c=document.createElement("button");c.className="group-action-btn edit-btn",c.innerHTML="<img class='group-action-btn-img' src='assets/edit.svg' alt='Edit' />",c.addEventListener("click",t=>{t.stopPropagation(),editSavedGroup(e,t)});const d=document.createElement("button");return d.className="group-action-btn delete-btn",d.innerHTML="<img class='group-action-btn-img' src='assets/bin.svg' alt='Delete' />",d.addEventListener("click",t=>{t.stopPropagation(),deleteSavedGroup(e,t)}),l.appendChild(c),l.appendChild(d),o.appendChild(s),o.appendChild(r),o.appendChild(i),o.appendChild(l),o.addEventListener("click",()=>{selectSavedGroup(e)}),o}function selectSavedGroup(e){document.querySelectorAll(".saved-group-card").forEach(e=>{e.classList.remove("selected")});const t=document.querySelector(`.saved-group-card[data-group-name="${e}"]`);t&&(t.classList.add("selected"),currentGroup=e,members=[...groups[e]],savedGroupError.style.display="none")}function editSavedGroup(e,t){isEditingGroup=!0,currentGroup=e,members=[...groups[e]],showSettleView("newGroupMembersView"),document.querySelector(".new-group-members-container h2").textContent="Edit Group",document.querySelector(".next-btn").textContent="Done";const n=document.querySelector(".edit-group-name-container"),o=document.getElementById("editGroupName");if(n&&o){n.style.display="block",o.value=e;const t=o.parentElement.querySelector(".error-message");t&&(t.style.display="none",t.textContent="Please enter group's name")}initializeMemberList(),t&&t.stopPropagation()}function deleteSavedGroup(e,t){t&&t.stopPropagation(),document.getElementById("deleteGroupModal").dataset.groupName=e,showModal("deleteGroupModal")}function showModal(e){const t=document.getElementById(e);if(t){t.style.display="flex",setTimeout(()=>{t.classList.add("active")},10);t.querySelectorAll(".error-message").forEach(e=>e.classList.remove("visible"));if(t.querySelectorAll(".input-field").forEach(e=>e.classList.remove("error")),"addMemberModal"===e){t.querySelectorAll("input").forEach(e=>e.value="");const e=t.querySelector("input");e&&setTimeout(()=>{e.focus(),setTimeout(()=>{e.click(),e.focus()},100)},300)}}}function hideModal(e){const t=document.getElementById(e);if(t){const e=t.querySelector(".modal-content");t.classList.add("closing"),e&&e.classList.add("closing"),setTimeout(()=>{t.classList.remove("active","closing"),e&&e.classList.remove("closing"),t.style.display="none"},300)}}function showGroupMembersView(e){e&&groups[e]?(currentGroup=e,members=[...groups[e]]):(members=[],currentGroup=""),birthdayPerson=null,initializeMemberList(),document.querySelector(".next-btn").textContent="Next",showSettleView("newGroupMembersView")}function saveGroupToStorage(){if(currentGroup){let e=currentGroup;if(isEditingGroup){const t=document.getElementById("editGroupName");if(t){const n=t.value.trim(),o=t.parentElement.querySelector(".error-message");if(!n)return void(o&&(o.textContent="Please enter group's name",o.style.display="block"));if(n!==currentGroup){if(groups[n])return void(o&&(o.textContent="A group with this name already exists",o.style.display="block"));delete groups[currentGroup],deleteGroupFromFirebase(currentGroup),e=n,currentGroup=n}o&&(o.style.display="none")}}groups[e]=[...members],localStorage.setItem("groups",JSON.stringify(groups)),saveGroupToFirebase(e,[...members])}}async function saveGroupToFirebase(e,t){try{const n=await getUserId(),o={name:e,members:t,timestamp:Date.now(),userId:n||null},a=await fetchWithUserId("/api/groups/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({groupName:e,groupData:o})});if(!a.ok)throw new Error(`Failed to save group to Firebase: ${a.statusText}`);await a.json()}catch(t){console.error(`Error saving group "${e}" to Firebase:`,t)}}async function deleteGroupFromFirebase(e){try{(await fetchWithUserId(`/api/groups/${encodeURIComponent(e)}`,{method:"DELETE"})).ok}catch(e){}}function addMemberToUI(e,t){const n=document.querySelector(".member-list"),o=document.createElement("div");o.className="member-item",o.dataset.name=e;const a=document.querySelectorAll(".member-item").length;o.style.animationDelay=.15*(a+1)+"s";const s=document.createElement("div");s.className="member-avatar";const r=document.createElement("img");r.src=`assets/cat-icon/cat-${t}.svg`,r.alt=`Cat avatar ${t}`,r.className="cat-avatar-img",s.appendChild(r),s.dataset.avatarNumber=t;const i=document.createElement("div");i.className="member-name",i.textContent=e,o.appendChild(s),o.appendChild(i),o.addEventListener("click",function(){openEditMemberModal(i.textContent,s.dataset.avatarNumber)}),n.appendChild(o)}function openEditMemberModal(e,t){document.getElementById("editMemberModal");const n=document.getElementById("editMemberName"),o=document.querySelector(".edit-member-avatar");n.value=e,o.innerHTML="";const a=document.createElement("img");a.src=`assets/cat-icon/cat-${t}.svg`,a.alt=`Cat avatar ${t}`,a.className="cat-avatar-img",o.appendChild(a),o.dataset.avatarNumber=t,n.dataset.originalName=e,showModal("editMemberModal")}function removeMember(){const e=document.getElementById("editMemberName").dataset.originalName,t=members.findIndex(t=>"object"==typeof t?t.name===e:t===e);-1!==t&&members.splice(t,1);document.querySelectorAll(".member-item").forEach(t=>{t.dataset.name===e&&(t.style.opacity="0",t.style.transform="translateY(10px)",setTimeout(()=>{t.remove()},300))}),"addSettleItemView"===currentSettleView&&setTimeout(()=>{updateSettleItemMembersUI()},350),hideModal("editMemberModal")}function addNewMember(){const e=document.getElementById("memberName"),t=e.value.trim(),n=e.closest(".input-field"),o=n.querySelector(".error-message");if(members.length>=20)return n.classList.add("error"),o.classList.add("visible"),void(o.textContent="Maximum of 20 members allowed");if(!t)return n.classList.add("error"),o.classList.add("visible"),void(o.textContent="Please enter a name");if(members.some(e=>"object"==typeof e?e.name===t:e===t))return n.classList.add("error"),o.textContent="This name already exists",void o.classList.add("visible");const a=members.filter(e=>"object"==typeof e&&e.avatar).map(e=>e.avatar),s=Array.from({length:20},(e,t)=>t+1).filter(e=>!a.includes(e)),r=s.length>0?s[Math.floor(Math.random()*s.length)]:Math.floor(20*Math.random())+1;members.push({name:t,avatar:r}),addMemberToUI(t,r),"addSettleItemView"===currentSettleView&&updateSettleItemMembersUI(),e.value="",n.classList.remove("error"),o.classList.remove("visible"),hideModal("addMemberModal")}function clearHistory(){showModal("clearHistoryConfirmModal")}function confirmClearHistory(){const e=document.querySelector(".history-list");e&&(e.innerHTML="<p class='no-history'>Clearing history...</p>"),fetchWithUserId("/api/history/clear",{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Failed to clear history from server");return e.json()}).then(e=>{fetchHistory(),hideModal("clearHistoryConfirmModal"),showToast("historyClearedToast")}).catch(e=>{console.error("Error clearing history:",e),fetchHistory(),hideModal("clearHistoryConfirmModal")})}function showToast(e){const t=document.getElementById(e);if(t){t.classList.add("show");const e=setTimeout(()=>{t.classList.remove("show")},3e3);t.addEventListener("click",function n(){clearTimeout(e),t.classList.remove("show"),t.removeEventListener("click",n),window.navigator&&window.navigator.vibrate&&window.navigator.vibrate(5)})}}function initPageNavigation(){document.getElementById("startSettleCard").addEventListener("click",function(){showSettleNowScreen()}),document.getElementById("clearHistoryBtn")?.addEventListener("click",function(){clearHistory()}),document.getElementById("confirmClearHistoryBtn")?.addEventListener("click",function(){confirmClearHistory()}),document.querySelector(".get-started-btn").addEventListener("click",function(){const e=document.querySelector(".saved-group-option").classList.contains("selected"),t=document.querySelector(".new-group-option").classList.contains("selected");if(document.querySelector(".new-group-error-message").style.display="none",e)Object.keys(groups).length>0?loadSavedGroups():(alert("No saved groups found. Please create a new group first."),document.querySelector(".new-group-option").click());else if(t){members=[],currentGroup="",birthdayPerson=null;const e=document.querySelector(".next-btn");e&&(e.textContent="Next");const t=document.querySelector(".new-group-members-container h2");t&&(t.textContent="Settle With New Group");const n=document.querySelector(".edit-group-name-container");n&&(n.style.display="none"),isEditingGroup=!1,showSettleView("newGroupMembersView"),initializeMemberList(),settleChoiceError.style.display="none"}else settleChoiceError.style.display="block"}),document.querySelector(".back-button").addEventListener("click",function(){handleSettleBackButton()}),document.querySelector(".saved-group-option").addEventListener("click",function(){this.classList.add("selected"),document.querySelector(".new-group-option").classList.remove("selected"),document.querySelector(".get-started-btn").disabled=!1,settleChoiceError.style.display="none"}),document.querySelector(".new-group-option").addEventListener("click",function(){this.classList.add("selected"),document.querySelector(".saved-group-option").classList.remove("selected"),document.querySelector(".get-started-btn").disabled=!1,settleChoiceError.style.display="none"}),document.querySelectorAll(".next-btn, .new-group-next-btn").forEach(e=>{e.addEventListener("click",function(){if(isEditingGroup&&currentGroup)return saveGroupToStorage(),document.getElementById("groupUpdatedModal").dataset.groupName=currentGroup,void showModal("groupUpdatedModal");if(0===members.length||members.length<2){return void(document.querySelector(".new-group-error-message").style.display="block")}document.querySelector(".new-group-error-message").style.display="none";previousView="newGroupMembersView";const e=document.querySelector(".new-favourite-group-btn"),t=document.querySelector(".group-success-message");e&&t&&(e.style.display="flex",t.classList.remove("visible")),showSettleView("addSettleItemView");const n=document.getElementById("addSettleItemView");n&&(n.scrollTop=0),updateSettleItemMembersUI()})}),document.querySelector(".add-member-button").addEventListener("click",function(){showModal("addMemberModal")}),document.querySelectorAll(".close-modal").forEach(function(e){e.addEventListener("click",function(){hideModal(this.closest(".modal").id)})}),document.querySelector(".add-member-submit").addEventListener("click",function(){addNewMember()}),document.querySelector(".save-member-btn").addEventListener("click",function(){saveEditedMember()}),document.querySelector(".remove-member-btn").addEventListener("click",function(){removeMember()}),document.getElementById("memberName").addEventListener("keypress",function(e){"Enter"===e.key&&addNewMember()}),document.getElementById("editMemberName").addEventListener("keypress",function(e){"Enter"===e.key&&saveEditedMember()}),document.getElementById("editGroupName").addEventListener("input",function(){const e=this.parentElement.querySelector(".error-message");e&&"none"!==e.style.display&&(e.style.display="none")}),document.querySelectorAll(".modal").forEach(function(e){e.addEventListener("click",function(e){e.target===this&&hideModal(this.id)})}),document.querySelector(".saved-groups-next-btn").addEventListener("click",function(){if(!currentGroup){return void(document.querySelector(".saved-group-error").style.display="block")}savedGroupError.style.display="none",previousView="savedGroupsView",showSettleView("addSettleItemView");const e=document.getElementById("addSettleItemView");e&&(e.scrollTop=0),updateSettleItemMembersUI();const t=document.querySelector(".new-favourite-group-btn"),n=document.querySelector(".group-success-message"),o=document.querySelector(".group-name-display");t&&n&&o&&(t.style.display="none",o.textContent=`Group "${currentGroup}" selected`,n.classList.add("visible"))})}const billSummaryCloseBtn=document.querySelector("#billSummaryModal .summary-close-modal");function closeBillSummaryModal(){const e=document.getElementById("billSummaryModal");e.classList.remove("fully-open","half-open"),e.classList.add("peeking");document.getElementById("billSummaryOverlay").classList.remove("active")}billSummaryCloseBtn&&billSummaryCloseBtn.addEventListener("click",function(){closeBillSummaryModal()});const navbarContainer=document.getElementById("navbarContainer");navbarContainer&&navbarContainer.classList.remove("navbar-hidden");const addItemBtn=document.querySelector(".add-item-btn");addItemBtn&&addItemBtn.addEventListener("click",function(){const e=document.getElementById("itemName").value.trim(),t=document.getElementById("itemPrice").value.trim(),n=Array.from(document.querySelector(".assigned-members").children).map(e=>e.dataset.name);let o=!1;if(e?document.getElementById("itemNameError").classList.remove("visible"):(document.getElementById("itemNameError").classList.add("visible"),o=!0),t?document.getElementById("itemPriceError").classList.remove("visible"):(document.getElementById("itemPriceError").classList.add("visible"),o=!0),0===n.length?(document.querySelector(".member-required-message").style.display="block",o=!0):document.querySelector(".member-required-message").style.display="none",o)return;document.getElementById("itemName").value="",document.getElementById("itemPrice").value="",document.querySelector(".assigned-members").innerHTML="",document.getElementById("settleEqually").checked=!1;const a={name:e,cost:t,members:n};dishes||(dishes=[]),dishes.push(a),showSummary();const s=document.getElementById("dishSummaryContainer");s&&setTimeout(()=>{s.scrollTo({top:s.scrollHeight,behavior:"smooth"})},100)});const newFavouriteGroupBtn=document.querySelector(".new-favourite-group-btn");newFavouriteGroupBtn&&newFavouriteGroupBtn.addEventListener("click",function(){showModal("createGroupModal");const e=document.getElementById("groupName");if(e){e.value="";const t=e.closest(".input-field");t.classList.remove("error");const n=t.querySelector(".error-message");n.classList.remove("visible"),n.textContent="Please enter group's name"}});const saveGroupBtn=document.querySelector(".save-group-btn");saveGroupBtn&&saveGroupBtn.addEventListener("click",function(){showModal("createGroupModal");const e=document.getElementById("groupName");if(e){e.value="";const t=e.closest(".input-field");t.classList.remove("error");const n=t.querySelector(".error-message");n.classList.remove("visible"),n.textContent="Please enter group's name"}});const cancelGroupBtn=document.querySelector(".create-group-modal .cancel-btn");cancelGroupBtn&&cancelGroupBtn.addEventListener("click",function(){hideModal("createGroupModal")});const confirmGroupBtn=document.querySelector(".create-group-modal .confirm-btn");confirmGroupBtn&&confirmGroupBtn.addEventListener("click",function(){const e=document.getElementById("groupName"),t=e.value.trim(),n=e.closest(".input-field"),o=n.querySelector(".error-message");if(!t)return n.classList.add("error"),void o.classList.add("visible");if(groups[t])return n.classList.add("error"),o.textContent="This group name already exists",void o.classList.add("visible");groups[t]=[...members],localStorage.setItem("groups",JSON.stringify(groups)),currentGroup=t,saveGroupToFirebase(currentGroup,[...members]),hideModal("createGroupModal");const a=document.querySelector(".group-success-message"),s=document.querySelector(".group-name-display"),r=document.querySelector(".new-favourite-group-btn"),i=document.querySelector(".save-group-section");a&&s&&(s.textContent=`Group "${t}" created`,a.classList.add("visible"),r&&(r.style.display="none"),i&&(i.style.display="none")),updateSettleItemMembersUI()});const closeGroupModalBtn=document.querySelector(".create-group-modal .close-modal");closeGroupModalBtn&&closeGroupModalBtn.addEventListener("click",function(){hideModal("createGroupModal")});const groupUpdatedConfirmBtn=document.querySelector(".group-updated-confirm-btn");groupUpdatedConfirmBtn&&groupUpdatedConfirmBtn.addEventListener("click",function(){hideModal(document.getElementById("groupUpdatedModal").id),isEditingGroup=!1,showSettleView("savedGroupsView"),updateSettleNowHeader(),loadSavedGroups()});const deleteConfirmBtn=document.querySelector(".delete-confirm-btn");deleteConfirmBtn&&deleteConfirmBtn.addEventListener("click",async function(){const e=document.getElementById("deleteGroupModal"),t=e.dataset.groupName;if(t){delete groups[t],localStorage.setItem("groups",JSON.stringify(groups));try{const e=await fetchWithUserId(`/api/groups/${encodeURIComponent(t)}`,{method:"DELETE"});e.ok||console.error(`Failed to delete group from Firebase: ${e.statusText}`)}catch(e){console.error(`Error deleting group "${t}" from Firebase:`,e)}loadSavedGroups()}hideModal(e.id)});const backConfirmBtn=document.querySelector(".back-confirm-btn");let WEATHER_API_KEY;backConfirmBtn&&backConfirmBtn.addEventListener("click",function(){hideModal("backConfirmModal");const e=document.getElementById("billSummaryModal");e&&(e.style.display="none"),document.querySelector(".assigned-members").innerHTML="",document.getElementById("dishSummaryContainer").innerHTML="",document.getElementById("itemName").value="",document.getElementById("itemPrice").value="",document.getElementById("settleEqually").checked=!1,dishes=[],birthdayPerson=null,closeSummary(),showSettleView(previousView),updateSettleNowHeader();const t=document.getElementById("receiptImage");if(t){t.value="";const e=document.querySelector(".upload-text");e&&(e.textContent="Choose File")}if("newGroupMembersView"===previousView)document.querySelector(".new-group-members-container h2").textContent=isEditingGroup?"Edit Group Members":"Settle With New Group";else if("settleChoiceView"===previousView){Object.keys(groups).length>0?(document.querySelector(".saved-group-option").style.display="flex",document.querySelector(".or-divider").style.display="flex"):(document.querySelector(".saved-group-option").style.display="none",document.querySelector(".or-divider").style.display="none",document.querySelector(".new-group-option").classList.add("selected"))}}),fetch("/api/config").then(e=>e.json()).then(e=>{WEATHER_API_KEY=e.WEATHER_API_KEY}).catch(e=>{console.error("Failed to fetch weather API key:",e)});const SINGAPORE_LAT=1.3521,SINGAPORE_LON=103.8198;async function fetchWeatherData(){try{const e=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${SINGAPORE_LAT}&lon=${SINGAPORE_LON}&appid=${WEATHER_API_KEY}&units=metric`),t=await e.json();document.querySelector(".weather-location p").textContent=t.weather[0].description,document.querySelector(".weather-temp h1").textContent=`${Math.round(t.main.temp)}`;const n=document.querySelector(".weather-icon"),o=t.weather[0].icon;n.innerHTML=`<img src="https://openweathermap.org/img/wn/${o}@2x.png" alt="Weather icon">`}catch(e){console.error("Error fetching weather data:",e)}}function initTaxProfileDropdown(){const e=document.getElementById("taxProfile");e&&(syncTaxProfileDropdown(),e.addEventListener("change",function(){updateTaxRates(this.value)}));const t=document.getElementById("serviceChargeValue");t&&t.addEventListener("input",function(){const e=document.getElementById("serviceRate");e&&(e.textContent=`${this.value}%`)})}function initThemeToggle(){document.getElementById("darkModeToggle").addEventListener("change",function(){this.checked?(document.body.classList.add("dark-mode"),localStorage.setItem("darkMode","enabled")):(document.body.classList.remove("dark-mode"),localStorage.setItem("darkMode","disabled"))})}function initializeMemberList(){const e=document.querySelector(".member-list");e&&(e.innerHTML="",members.forEach(e=>{if("object"==typeof e&&e.name)addMemberToUI(e.name,e.avatar);else{const t=e,n=t.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);addMemberToUI(t,Math.abs(n%20)+1)}}))}function createNewGroup(){showModal("createGroupModal")}function showSavedGroupsModal(){const e=Object.keys(groups),t=document.querySelector(".saved-groups-list"),n=document.querySelector(".no-saved-groups");t.innerHTML="",0===e.length?(t.style.display="none",n.style.display="block"):(t.style.display="flex",n.style.display="none",e.forEach(e=>{const n=groups[e].length,o=document.createElement("div");o.className="group-item",o.innerHTML=`\n        <div class="group-item-name">${e}</div>\n        <div class="group-item-count">${n} members</div>\n      `,o.addEventListener("click",function(){hideModal("savedGroupsModal"),showGroupMembersView(e)}),t.appendChild(o)})),showModal("savedGroupsModal")}function updateSettleItemMembersUI(){const e=document.querySelector(".group-members");e.innerHTML="",members.forEach(t=>{let n,o;if("object"==typeof t&&t.name)n=t.name,o=t.avatar;else{n=t;const e=n.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);o=Math.abs(e%20)+1}const a=document.createElement("div");a.className="member-avatar-wrapper sortable-item",a.dataset.name=n;const s=document.createElement("div");s.className="member-avatar";const r=document.createElement("img");r.src=`assets/cat-icon/cat-${o}.svg`,r.alt=`Cat avatar ${o}`,r.className="cat-avatar-img",s.appendChild(r);const i=document.createElement("div");i.className="member-name",i.textContent=n,a.appendChild(s),a.appendChild(i),e.appendChild(a)}),updateBirthdayPersonButton(),initializeMemberDragForSettleItem();const t=document.querySelector(".scan-item-btn");t&&(t.style.display="flex")}function initializeMemberDragForSettleItem(){const e=document.querySelector(".group-members"),t=document.querySelector(".assigned-members"),n=document.getElementById("settleEqually");n.addEventListener("change",function(){t.innerHTML="",this.checked&&members.forEach(o=>{const a="object"==typeof o?o.name:o,s=Array.from(e.children).find(e=>e.dataset.name===a);if(s){const e=s.cloneNode(!0);let o=!1;e.addEventListener("touchend",function(t){o?(t.preventDefault(),e.remove(),n.checked=!1):(o=!0,setTimeout(function(){o=!1},300))}),e.addEventListener("dblclick",function(){e.remove(),n.checked=!1}),t.appendChild(e)}})}),"undefined"!=typeof Sortable&&(Sortable.create(e,{group:{name:"settleMembers",pull:"clone",put:!1},sort:!1,animation:150,onStart:function(){navigator.vibrate&&navigator.vibrate(25)}}),Sortable.create(t,{group:"settleMembers",animation:150,onAdd:function(e){const o=e.item,a=o.dataset.name;if(Array.from(t.children).filter(e=>e!==o).map(e=>e.dataset.name).includes(a))return void o.remove();n.checked=!1;let s=!1;o.addEventListener("touchend",function(e){s?(e.preventDefault(),o.remove(),navigator.vibrate&&navigator.vibrate(25)):(s=!0,setTimeout(function(){s=!1},300))}),o.addEventListener("dblclick",function(){o.remove()})},onStart:function(){navigator.vibrate&&navigator.vibrate(25)}}))}function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>alert("Link copied to clipboard!")).catch(e=>alert("Failed to copy link."))}function resetScanningOverlay(){const e=document.querySelector(".scan-receipt-overlay"),t=document.querySelector(".scanning-text"),n=document.getElementById("scanReceiptBtn");e&&(e.classList.remove("active"),e.style.transition="",e.style.opacity=""),t&&(t.textContent="Scanning your receipt...",t.style.animation="",t.style.color=""),n&&(n.disabled=!1,n.textContent="Scan Receipt")}document.addEventListener("DOMContentLoaded",function(){void 0===dishes&&(window.dishes=[]);const e=document.querySelector(".welcome-section h1");if(e){const t=localStorage.getItem("settlelah_user_name");e.textContent=t?`Welcome back, ${t}!`:"Welcome back!"}initTaxProfileDropdown(),initThemeToggle(),hideSettleNowScreen(),initializeMemberList(),initializeSwipeGesture(),moveWithCalc(2),currentActiveBubble=2,switchPage(2),"enabled"===localStorage.getItem("darkMode")&&(document.body.classList.add("dark-mode"),document.getElementById("darkModeToggle").checked=!0);const t=localStorage.getItem("taxProfile");t?(document.getElementById("taxProfile").value=t,updateTaxRates(t)):(localStorage.setItem("taxProfile","singapore"),updateTaxRates("singapore")),document.getElementById("taxProfile").addEventListener("change",function(){const e=this.value;localStorage.setItem("taxProfile",e),updateTaxRates(e)}),document.querySelectorAll(".menuElement").forEach(e=>{e.style.pointerEvents="auto"}),fetchWeatherData(),setInterval(fetchWeatherData,18e5),document.querySelectorAll(".modal .close-modal").forEach(function(e){e.addEventListener("click",function(){hideModal(this.closest(".modal").id)})}),document.querySelectorAll(".modal .cancel-btn").forEach(function(e){e.addEventListener("click",function(){hideModal(this.closest(".modal").id)})});const n=function(){const e=document.getElementById("itemName"),t=document.getElementById("itemPrice");e&&t&&[e,t].forEach(e=>{e.addEventListener("touchstart",function(e){this.style.willChange="transform"},{passive:!0}),e.addEventListener("blur",function(){this.style.willChange="auto"},{passive:!0})})};n();const o=document.getElementById("addSettleItemView");if(o){new MutationObserver(function(e){e.forEach(function(e){"class"===e.attributeName&&o.classList.contains("active")&&n()})}).observe(o,{attributes:!0})}const a=document.getElementById("receiptImage");a&&a.addEventListener("change",function(){const e=document.querySelector(".upload-text");e&&a.files.length>0&&(e.textContent=a.files[0].name)})}),window.addEventListener("resize",handleResize);const scanItemBtn=document.querySelector(".scan-item-btn");async function updateHomePageCards(){await updateLastCreatedGroup(),updateLastSettle()}async function updateLastCreatedGroup(){const e=document.querySelector(".group-card:nth-child(4)");if(!e)return;e.classList.add("loading");let t={},n=!1;try{const e=await fetchWithUserId("/api/groups");if(!e.ok)throw new Error(`Firebase fetch failed: ${e.statusText}`);{const o=await e.json();o.groups&&(t=o.groups,n=!0,localStorage.setItem("groups",JSON.stringify(t)))}}catch(e){console.error("Error fetching groups from Firebase, falling back to localStorage:",e),t=JSON.parse(localStorage.getItem("groups")||"{}"),n=!1}const o=Object.keys(t);if(0===o.length)return void setTimeout(()=>{const t=e.querySelector(".card-header p");t&&(t.textContent="No groups yet");const n=e.querySelector(".avatar-group");n&&(n.innerHTML='<p class="empty-state-message">Create a group when you settle</p>'),e.classList.remove("loading"),e.style.display="block"},2e3);const a=o[0],s=t[a];setTimeout(()=>{const t=e.querySelector(".card-header p");t&&(t.textContent=a);const n=e.querySelector(".avatar-group");if(n&&s&&s.length>0){n.innerHTML="";if(s.slice(0,5).forEach(e=>{let t;if("object"==typeof e&&e.name)t=e.avatar;else{const n=e.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);t=Math.abs(n%20)+1}const o=document.createElement("div");o.className="avatar",o.innerHTML=`<img class="avatar-img" src="assets/cat-icon/cat-${t}.svg" />`,n.appendChild(o)}),s.length>5){const e=document.createElement("div");e.textContent="+",n.appendChild(e)}}e.classList.remove("loading"),e.style.display="block"},2e3)}function updateLastSettle(){const e=document.querySelector(".group-card:nth-child(5)");e&&(e.classList.add("loading"),fetchWithUserId("/api/history/latest",{method:"GET",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error(`HTTP error ${e.status}`);return e.json()}).then(t=>{setTimeout(()=>{if(e.classList.remove("loading"),e.style.display="block",!t||!t.bill){const t=e.querySelector(".arrow-icon");t&&(t.style.display="none");const n=e.querySelector(".settle-info");if(n){const e=n.querySelector(".settle-info-amount"),t=n.querySelector(".settle-info-matter"),o=n.querySelector(".settle-info-group");e&&(e.textContent="No settlements yet"),t&&(t.textContent="Start settling bills with your friends"),o&&(o.textContent="Tap 'Settle Now' to begin")}const o=e.querySelector(".settle-info-date span");o&&(o.textContent="");const a=e.querySelector(".avatar-group");return a&&(a.innerHTML=""),void(e.href="javascript:void(0)")}const n=t.bill;updateSettleCardContent(e,n.id,n)},300)}).catch(t=>{console.error("Error fetching latest settlement:",t),e.classList.remove("loading"),e.style.display="block";const n=e.querySelector(".settle-info");if(n){const e=n.querySelector(".settle-info-amount");e&&(e.textContent="Error loading")}}))}function updateSettleCardContent(e,t,n){if(!n)return;e.href=`/bill/${t}`,e.target="_blank";const o=e.querySelector("#lastSettle .settle-info-amount");o&&n.breakdown&&n.breakdown.total&&(o.textContent=`$${roundToNearest5Cents(n.breakdown.total)}`);const a=e.querySelector("#lastSettle .settle-info-matter");a&&(a.textContent=n.settleMatter||"Settlement");const s=e.querySelector("#lastSettle .settle-info-group");if(s){const e=n.members?n.members.length:0;s.textContent=`${e} members`}const r=e.querySelector("#lastSettle .settle-info-date span");if(r&&n.timestamp){const e=new Date(n.timestamp);r.textContent=e.toLocaleString()}const i=e.querySelector("#lastSettle .avatar-group");if(i&&n.members&&n.members.length>0){i.innerHTML="";if(n.members.slice(0,5).forEach(e=>{const t=document.createElement("div");t.className="avatar",t.innerHTML=`<img class="avatar-img" src="assets/cat-icon/cat-${e.avatar||1}.svg" />`,i.appendChild(t)}),n.members.length>5){const e=document.createElement("div");e.textContent="+",i.appendChild(e)}}}function roundToNearest5Cents(e){"string"==typeof e&&(e=parseFloat(e));const t=(e=parseFloat(e.toFixed(2)))-Math.floor(e),n=Math.round(100*t),o=n%10;if(o<5){return(e-o/100).toFixed(2)}if(5===o)return e.toFixed(2);return(e+(10*Math.ceil(n/10)-n)/100).toFixed(2)}function showNotification(e){const t=document.createElement("div");t.className="toast-notification",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{document.body.removeChild(t)},300)},3e3)}function syncTaxProfileDropdown(){const e=document.getElementById("taxProfile"),t=localStorage.getItem("taxProfile")||"singapore";e&&(e.value=t,updateTaxRates(t))}function isValidBillId(e){return/^[a-z0-9]+-[a-z0-9]+-[a-z0-9]+$/i.test(e)||/^[a-z0-9]{6}$/i.test(e)}function addBillToHistory(e,t){isValidBillId(e)||console.warn(`Attempted to store invalid bill ID: ${e}`)}function loadBillHistory(){}async function syncDataFromFirebase(){try{await fetchGroupsFromFirebase()}catch(e){console.error("Error syncing data from Firebase:",e)}}function isRunningAsPWA(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone}function deleteHistoryRecord(e,t){fetchWithUserId(`/api/history/${encodeURIComponent(e)}`,{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Failed to delete record");t&&t.parentNode&&(t.style.transition="all 0.3s ease",t.style.opacity="0",t.style.transform="translateX(-100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)),showToast("itemDeletedToast")}).catch(e=>{alert("Error deleting record. Please try again."),console.error(e)})}function updateReceiptDetails(e,t){const n=e.querySelector(".successSettleMatter"),o=e.querySelector(".successDate"),a=e.querySelector(".successTime"),s=e.querySelector(".successItemCount"),r=e.querySelector(".successSubtotal"),i=e.querySelector(".successServiceCharge"),l=e.querySelector(".serviceChargeRow"),c=e.querySelector(".serviceChargeRate"),d=e.querySelector(".successAfterService"),m=e.querySelector(".afterServiceRow"),u=e.querySelector(".successDiscount"),p=e.querySelector(".discountRow"),y=e.querySelector(".discount-rate"),h=e.querySelector(".successAfterDiscount"),g=e.querySelector(".afterDiscountRow"),v=e.querySelector(".successGST"),b=e.querySelector(".gstRow"),f=e.querySelector(".gstRate"),S=e.querySelector(".successAmount"),E=e.querySelector(".successOriginalAmount"),w=e.querySelector(".originalAmountRow"),L=e.querySelector(".successPayer");if(n&&(n.textContent=t.settleMatter||"No one ask!"),o&&(o.textContent=t.dateString),a&&(a.textContent=t.timeString),s&&(s.textContent=t.itemCount),r&&(r.textContent=t.subtotal),L&&t.payer?L.textContent=t.payer.name:L&&(L.textContent=t.paynowName||"Not specified"),i&&l){const e=parseFloat(t.serviceCharge.replace("$",""));e>0?(i.textContent=`$${e.toFixed(2)}`,l.style.display="",c&&(c.textContent=t.serviceChargeRate||"10%")):l.style.display="none"}if(d&&m){const e=parseFloat(t.serviceCharge.replace("$",""));if(e>0){const n=parseFloat(t.subtotal.replace("$",""))+e;d.textContent=`$${n.toFixed(2)}`,m.style.display=""}else m.style.display="none"}if(u&&p){const e=parseFloat(t.discount?.replace("$","")||"0");e>0?(u.textContent=`$${e.toFixed(2)}`,y&&t.discountInput&&(y.textContent=`(${t.discountInput})`),p.style.display=""):p.style.display="none"}if(h&&g){const e=parseFloat(t.discount?.replace("$","")||"0");if(e>0){const n=parseFloat(t.subtotal.replace("$",""))+parseFloat(t.serviceCharge.replace("$",""))-e;h.textContent=`$${n.toFixed(2)}`,g.style.display=""}else g.style.display="none"}if(v&&b){const e=parseFloat(t.gst.replace("$",""));e>0?(v.textContent=`$${e.toFixed(2)}`,b.style.display="",f&&(f.textContent=t.gstRate||"9%")):b.style.display="none"}if(E&&w&&S){const e=parseFloat(t.totalAmount.replace("$","")),n=roundToNearest5Cents(e);Math.abs(e-n)>.001?(E.textContent=`$${e.toFixed(2)}`,w.style.display="",S.textContent=`$${n}`):(w.style.display="none",S.textContent=`$${e.toFixed(2)}`)}else if(S){const e=roundToNearest5Cents(parseFloat(t.totalAmount.replace("$","")));S.textContent=`$${e}`}}function updateBirthdayPersonButton(){const e=document.getElementById("birthdayPersonBtn");e&&(members.length>=2?(e.style.display="flex",birthdayPerson?(e.classList.add("has-birthday-person"),e.querySelector(".birthday-text").innerHTML=`<span class="birthday-icon"></span> ${birthdayPerson} (Birthday)`):(e.classList.remove("has-birthday-person"),e.querySelector(".birthday-text").innerHTML="<span class='birthday-icon'></span> Someone Birthday?")):e.style.display="none")}function showBirthdayPersonModal(){document.getElementById("birthdayPersonModal");const e=document.getElementById("birthdayMembersList"),t=document.querySelector(".birthday-status-display"),n=document.querySelector(".birthday-member-name"),o=(document.getElementById("confirmBirthdayPersonBtn"),document.getElementById("clearBirthdayPersonBtn"));if(e.innerHTML="",members.forEach(a=>{const s="object"==typeof a?a.name:a,r="object"==typeof a?a.avatar:Math.abs(s.split("").reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0)%20)+1,i=document.createElement("div");i.className="member-avatar-wrapper",i.setAttribute("data-name",s),birthdayPerson===s&&i.classList.add("selected"),i.innerHTML=`\n      <div class="member-avatar">\n        <img src="assets/cat-icon/cat-${r}.svg" alt="Cat avatar" class="cat-avatar-img">\n      </div>\n      <div class="member-name">${s}</div>\n    `,i.addEventListener("click",function(){document.querySelectorAll("#birthdayMembersList .member-avatar-wrapper").forEach(e=>{e.classList.remove("selected")}),this.classList.add("selected"),t.style.display="block",n.textContent=s,o.style.display=birthdayPerson===s?"inline-block":"none"}),e.appendChild(i)}),birthdayPerson){t.style.display="block",n.textContent=birthdayPerson,o.style.display="inline-block";const a=e.querySelector(`[data-name="${birthdayPerson}"]`);a&&a.classList.add("selected")}else t.style.display="none",o.style.display="none";showModal("birthdayPersonModal")}function confirmBirthdayPerson(){const e=document.querySelector("#birthdayMembersList .member-avatar-wrapper.selected");if(e){const t=e.getAttribute("data-name");birthdayPerson=t,updateBirthdayPersonVisuals(),updateBirthdayPersonButton(),showToast("birthdayPersonToast");const n=document.getElementById("birthdayPersonToast");if(n){const e=n.querySelector(".toast-message");e&&(e.textContent=` ${birthdayPerson} is the birthday person!`)}}hideModal("birthdayPersonModal")}function clearBirthdayPerson(){birthdayPerson=null,updateBirthdayPersonVisuals(),updateBirthdayPersonButton(),showToast("birthdayPersonClearedToast"),hideModal("birthdayPersonModal")}function updateBirthdayPersonVisuals(){document.querySelectorAll(".group-members .member-avatar-wrapper").forEach(e=>{const t=e.dataset.name,n=e.querySelector(".member-avatar"),o=e.querySelector(".member-name");t===birthdayPerson?(n.classList.add("birthday-person"),o.classList.add("birthday-person")):(n.classList.remove("birthday-person"),o.classList.remove("birthday-person"))})}scanItemBtn&&scanItemBtn.addEventListener("click",function(){resetScanningOverlay(),showModal("scanReceiptModal")}),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("scanReceiptBtn");e&&e.addEventListener("click",function(){scanReceipt()})}),document.addEventListener("DOMContentLoaded",function(){updateHomePageCards(),document.getElementById("menu2").addEventListener("click",function(){updateHomePageCards()})}),window.addEventListener("load",function(){syncTaxProfileDropdown()}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll('input[type="number"]').forEach(e=>{e.addEventListener("wheel",function(e){e.preventDefault()},{passive:!1})})}),window.onload=async function(){isRunningAsPWA()&&(document.body.style.height="100vh",document.body.classList.add("pwa-mode")),await syncDataFromFirebase().then(()=>{console.log("Data synchronization complete")}),await updateHomePageCards(),setTimeout(async()=>{initializePullToRefresh(),document.getElementById("taxProfile").value="singapore",document.getElementById("serviceRate").textContent="10%",document.getElementById("gstRate").textContent="9%",initPageNavigation(),initializeSwipeGesture(),initializeBillSummaryDrag(),initTaxProfileDropdown(),initThemeToggle(),fetchWeatherData(),await updateHomePageCards(),setTimeout(()=>{document.querySelectorAll(".card-widget").forEach((e,t)=>{setTimeout(()=>{e.classList.add("animated")},100*t)})},100),setTimeout(()=>{document.querySelectorAll(".group-card").forEach((e,t)=>{setTimeout(()=>{e.classList.add("animated")},100*t)})},100);const e=document.getElementById("preloader");e&&(e.classList.add("fade-out"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},500))},100)},document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("birthdayPersonBtn");e&&e.addEventListener("click",showBirthdayPersonModal);const t=document.getElementById("confirmBirthdayPersonBtn");t&&t.addEventListener("click",confirmBirthdayPerson);const n=document.getElementById("clearBirthdayPersonBtn");n&&n.addEventListener("click",clearBirthdayPerson)});