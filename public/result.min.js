<<<<<<< HEAD
document.addEventListener("touchstart",function(e){e.touches.length>1&&(e.preventDefault(),e.stopPropagation())},{passive:!1}),document.addEventListener("gesturestart",function(e){e.preventDefault()},{passive:!1}),function(){const e=window.matchMedia("(prefers-color-scheme: dark)");let t=localStorage.getItem("theme")||(e.matches?"dark":"light");const n=e=>{"dark"===e?(document.body.classList.add("dark-mode"),document.documentElement.classList.add("dark-mode")):(document.body.classList.remove("dark-mode"),document.documentElement.classList.remove("dark-mode")),localStorage.setItem("theme",e),t=e};n(t),e.addEventListener("change",e=>{localStorage.getItem("theme")||n(e.matches?"dark":"light")}),document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("button");function a(){e.innerHTML="dark"===t?'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" fill="currentColor"/>\n            <path fill-rule="evenodd" clip-rule="evenodd" d="M11 0H13V4.06189C12.6724 4.02104 12.3387 4 12 4C11.6613 4 11.3276 4.02104 11 4.06189V0ZM7.0943 5.68018L4.22173 2.80761L2.80752 4.22183L5.68008 7.09439C6.07016 6.55685 6.55674 6.07027 7.0943 5.68018ZM4.06189 11H0V13H4.06189C4.02104 12.6724 4 12.3387 4 12C4 11.6613 4.02104 11.3276 4.06189 11ZM5.68008 16.9056L2.80751 19.7782L4.22173 21.1924L7.0943 18.3198C6.55674 17.9297 6.07016 17.4431 5.68008 16.9056ZM11 19.9381V24H13V19.9381C12.6724 19.979 12.3387 20 12 20C11.6613 20 11.3276 19.979 11 19.9381ZM16.9056 18.3199L19.7781 21.1924L21.1923 19.7782L18.3198 16.9057C17.9297 17.4432 17.4431 17.9298 16.9056 18.3199ZM19.9381 13H24V11H19.9381C19.979 11.3276 20 11.6613 20 12C20 12.3387 19.979 12.6724 19.9381 13ZM18.3198 7.0943L21.1923 4.22183L19.7781 2.80762L16.9056 5.68008C17.4431 6.07016 17.9297 6.55674 18.3198 7.0943Z" fill="currentColor"/>\n           </svg>':'<img src="/assets/moon.svg" alt="Moon" width="20" height="20">'}e.setAttribute("id","theme-toggle"),e.setAttribute("aria-label","Toggle dark mode"),a(),e.addEventListener("click",function(){n("dark"===t?"light":"dark"),a()}),document.body.appendChild(e)})}();let memberData={},billData={},billId="",payerName="",paymentStatus={};function isDesktopMode(){return window.matchMedia("(min-width: 1100px)").matches}function showShareModal(e){const t=document.getElementById("memberbillModal"),n=document.getElementById("memberbillOverlay"),a=document.querySelector(".member-close-modal"),s=document.querySelector(".member-bill-modal .modal-header h2"),o=document.querySelector(".member-bill-modal-body");function i(){if(e&&memberData[e]){const n=memberData[e],a=isDesktopMode(),i=n.isBirthdayPerson;let r=e===payerName?`üí∏ ${e}`:e;if(i&&(r=`üéÇ ${e} (Birthday)`),s.textContent=`Settle Detail - ${r}`,a){t.classList.add("desktop-mode");const a="singapore"===n.taxProfile;if(e===payerName&&"$0.00"===n.totalAmount)return void showPayerTracking(e);o.innerHTML=`\n          <div class="desktop-layout">\n            <div class="member-bill-modal-details modal-fade-in">\n              <div style="text-align: center;">\n                <h2 class="member-bill-title">Settle Detail</h2>\n                <h1 class="member-bill-amount">${n.totalAmount}</h1>\n              </div>\n              \n              <hr class="member-bill-divider">\n              \n              <h3 class="member-bill-section-title">Items</h3>\n              <div class="animate-staggered">\n                ${n.items.map((e,t)=>`\n                  <div class="member-bill-item-container">\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Item Name</span>\n                      <span class="member-bill-row-value">${e.name}</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Shared With</span>\n                      <div class="shared-with-container">${e.sharedWith||"-"}</div>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Item Price</span>\n                      <span class="member-bill-row-value">${e.price}</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Price Per Person</span>\n                      <span class="member-bill-row-value">\n                        ${(()=>{const t=e.sharedWith?(e.sharedWith.match(/<span class="shared-member">/g)||[]).length+1:1,n=(parseFloat(e.price.replace("$",""))/t).toFixed(2);return 1===t?`$${n}`:`$${n} <span class="people-count">(√∑${t} Incl. You)</span>`})()}\n                      </span>\n                    </div>\n                    ${t<n.items.length-1?'<hr class="member-bill-divider">':""}\n                  </div>\n                `).join("")}\n                \n                ${n.birthdayShare>0?`\n                  <div class="member-bill-item-container birthday-share-item">\n                    <div class="birthday-share-header">\n                      <span class="birthday-share-icon">üéÇ</span>\n                      <span class="birthday-share-title">Birthday Contribution</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Helping to celebrate</span>\n                      <span class="member-bill-row-value">${billData?.birthdayPerson||"Birthday person"}'s special day</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Your contribution</span>\n                      <span class="member-bill-row-value birthday-contribution">+$${n.birthdayShare.toFixed(2)}</span>\n                    </div>\n                  </div>\n                  `:""}\n                \n                ${!n.isBirthdayPerson&&billData?.birthdayPerson&&memberData[billData.birthdayPerson]?`\n                  <div class="member-bill-item-container birthday-person-breakdown">\n                    <div class="birthday-breakdown-header">\n                      <span class="birthday-breakdown-title">What ${billData.birthdayPerson} Ordered</span>\n                    </div>\n                    <div class="birthday-person-items-reference">\n                      ${memberData[billData.birthdayPerson].items.map(e=>`\n                        <div class="birthday-reference-item">\n                          <span class="birthday-reference-name">${e.name}</span>\n                        </div>\n                      `).join("")}\n                      ${0===memberData[billData.birthdayPerson].items.length?'<span class="no-items-reference">No items ordered</span>':""}\n                    </div>\n                  </div>\n                  `:""}\n              </div>\n              \n              <hr class="member-bill-solid-divider">\n              \n              <h3 class="member-bill-section-title">Amount Breakdown</h3>\n              <div class="total-section animate-staggered">\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">Subtotal</span>\n                  <span class="member-bill-row-value">${n.breakdown.subtotal}</span>\n                </div>\n                ${parseFloat(n.breakdown.serviceCharge.replace("$",""))>0?`\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Service Charge (${n.serviceChargeRate})</span>\n                    <span class="member-bill-row-value">${n.breakdown.serviceCharge}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">After Service</span>\n                    <span class="member-bill-row-value">${n.breakdown.afterService}</span>\n                  </div>\n                  `:""}\n                ${parseFloat(n.breakdown.discount.replace("$",""))>0?`\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Discount${n.discount?` (${n.discount})`:""}</span>\n                    <span class="member-bill-row-value">${n.breakdown.discount}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">After Discount</span>\n                    <span class="member-bill-row-value">${n.breakdown.afterDiscount}</span>\n                  </div>\n                  `:""}\n                ${parseFloat(n.breakdown.gst.replace("$",""))>0?`\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">GST (${"singapore"===n.taxProfile?"9%":"malaysia"===n.taxProfile?"6%":"9%"})</span>\n                    <span class="member-bill-row-value">${n.breakdown.gst}</span>\n                  </div>\n                  `:""}\n              </div>\n            </div>\n            \n            ${e===payerName||n.isBirthdayPerson?n.isBirthdayPerson?'\n            <div class="birthday-celebration-panel modal-fade-in">\n              <div style="text-align: center; padding: 20px;">\n                <h2 class="celebration-title">üéÇ Happy Birthday!</h2>\n                <p class="celebration-message">Your friends are treating you today!</p>\n                <div class="birthday-gift-icon">üéÅ</div>\n                <p class="celebration-subtitle">Enjoy your special day!</p>\n              </div>\n            </div>\n            ':"$0.00"===n.totalAmount?`\n            <div class="payer-tracking-section modal-fade-in">\n              <div class="payment-summary-compact">\n                <div class="summary-stats">\n                  <div class="stat-card paid-stat">\n                    <div class="stat-number">${getPaidMembersCount()}</div>\n                    <div class="stat-label">Paid</div>\n                  </div>\n                  <div class="stat-card pending-stat">\n                    <div class="stat-number">${getPendingMembersCount()}</div>\n                    <div class="stat-label">Pending</div>\n                  </div>\n                  <div class="stat-card amount-stat">\n                    <div class="stat-number">${getOutstandingAmount()}</div>\n                    <div class="stat-label">Outstanding</div>\n                  </div>\n                </div>\n                \n                <div class="progress-bar-container">\n                  <div class="progress-bar">\n                    <div class="progress-fill" style="width: ${getPaymentProgress()}%"></div>\n                  </div>\n                  <div class="progress-text">${getPaymentProgress()}% Complete</div>\n                </div>\n              </div>\n              \n              <div class="members-status-list-compact">\n                <h4>Member Payment Status</h4>\n                ${getMembersStatusList()}\n              </div>\n            </div>\n            `:`\n            \n            \n            <div class="payer-tracking-section modal-fade-in">\n              <h2 class="paynow-title">Payment Tracking Dashboard</h2>\n              \n              <div class="payment-summary-compact">\n                <div class="summary-stats">\n                  <div class="stat-card paid-stat">\n                    <div class="stat-number">${getPaidMembersCount()}</div>\n                    <div class="stat-label">Paid</div>\n                  </div>\n                  <div class="stat-card pending-stat">\n                    <div class="stat-number">${getPendingMembersCount()}</div>\n                    <div class="stat-label">Pending</div>\n                  </div>\n                  <div class="stat-card amount-stat">\n                    <div class="stat-number">${getOutstandingAmount()}</div>\n                    <div class="stat-label">Outstanding</div>\n                  </div>\n                </div>\n                \n                <div class="progress-bar-container">\n                  <div class="progress-bar">\n                    <div class="progress-fill" style="width: ${getPaymentProgress()}%"></div>\n                  </div>\n                  <div class="progress-text">${getPaymentProgress()}% Complete</div>\n                </div>\n              </div>\n              \n              <div class="members-status-list-compact">\n                <h4>Member Payment Status</h4>\n                ${getMembersStatusList()}\n              </div>\n            </div>\n            `:`\n            <div class="paynow-section modal-fade-in">\n              <h2 class="paynow-title">Please Transfer to</h2>\n              ${a?`\n                <div class="paynow-qr-container" id="paynow-qr-container">\n                  <img src="https://www.sgqrcode.com/paynow?mobile=${n.paymentInfo.phoneNumber}&uen=&editable=1&amount=${n.paymentInfo.amount.replace("$","")}&expiry=${(new Date).toISOString().split("T")[0].replace(/-/g,"%2F")}%2023%3A59&ref_id=SettleLah-${n.paymentInfo.name+"%20"+n.paymentInfo.settleMatter||"SettleLah"}&company=" alt="PayNow QR Code" class="desktop-qr-code">\n                </div>\n                <button id="downloadQRBtn" class="download-qr-btn">\n                  <svg xmlns="http://www.w3.org/2000/svg" fill="#ffffff" width="800px" height="800px" viewBox="0 0 24 24" id="download-5" class="icon line"><polyline id="primary" points="15 14 12 17 9 14" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/><path id="primary-2" data-name="primary" d="M12,17V3M4,17v3a1,1,0,0,0,1,1H19a1,1,0,0,0,1-1V17" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/></svg>\n                  Download QR\n                </button>\n                <div class="paynow-instructions">\n                  <p>Please pay <b class="paynow-amount">${n.paymentInfo.amount}</b> to <b class="paynow-name">${n.paymentInfo.name} (${n.paymentInfo.phoneNumber})</b>.</p>\n                  <p>Scan the QR code to complete transfer or copy the phone number to start transfer.</p>\n                </div>\n                <div class="bill-result-button-div">\n                <button id="copyPhoneBtn" class="action-button secondary-button">\n                  Copy Phone Number\n                </button>\n                `:`\n                <div class="paynow-instructions">\n                  <p>Please pay <b class="paynow-amount">${n.paymentInfo.amount}</b> to <b class="paynow-name">${n.paymentInfo.name} (${n.paymentInfo.phoneNumber})</b> using DuitNow payment method.</p>\n                </div>\n                <div class="bill-result-button-div">\n                <button id="copyPhoneBtn" class="action-button secondary-button">\n                  Copy Phone Number\n                </button>\n                `}\n              \n              ${paymentStatus[e]?.hasPaid?'\n                <div class="payment-status-indicator paid">\n                  <span class="payment-status-text">‚úì Payment Confirmed</span>\n                </div>\n              ':'\n                <button id="havePaidBtn" class="action-button primary-button" style="margin-top: 15px;">\n                  I Have Paid!\n                </button>\n              '}\n              </div>\n            </div>\n            `}\n          </div>\n        `;const s=document.getElementById("copyPhoneBtn");s&&s.addEventListener("click",()=>{navigator.clipboard.writeText(n.paymentInfo.phoneNumber).then(()=>{const e=document.createElement("div");e.textContent="Phone number copied!",e.className="toast-notification",document.body.appendChild(e),setTimeout(()=>{e.classList.add("toast-fadeout"),setTimeout(()=>{document.body.removeChild(e)},500)},2e3)}).catch(e=>{console.error("Failed to copy phone number: ",e)})});const i=document.getElementById("havePaidBtn");i&&i.addEventListener("click",()=>{showPaymentConfirmation(e)});const r=document.getElementById("downloadQRBtn");r&&r.addEventListener("click",()=>{const t=document.querySelector("#paynow-qr-container img");t&&downloadQRCode(t,e)})}else{t.classList.remove("desktop-mode");if(e===payerName&&"$0.00"===n.totalAmount)return void showPayerTracking(e);o.innerHTML=`\n          <div class="member-bill-modal-details modal-fade-in">\n            <div style="text-align: center;">\n              <h2 class="member-bill-title">${e===payerName?"Your Bill Breakdown":"Settle Detail"}</h2>\n              <h1 class="member-bill-amount">${n.totalAmount}</h1>\n            </div>\n            \n            <hr class="member-bill-divider">\n            \n            <h3 class="member-bill-section-title">Items</h3>\n            <div class="animate-staggered">\n              ${n.items.map((t,a)=>`\n                <div class="member-bill-item-container">\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Item Name</span>\n                    <span class="member-bill-row-value">${t.name}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Shared With</span>\n                    <div class="shared-with-container">${t.sharedWith||(e===payerName?"Just You":"-")}</div>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Item Price</span>\n                    <span class="member-bill-row-value">${t.price}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Price Per Person</span>\n                    <span class="member-bill-row-value">\n                      ${(()=>{const e=t.sharedWith?(t.sharedWith.match(/<span class="shared-member">/g)||[]).length+1:1,n=(parseFloat(t.price.replace("$",""))/e).toFixed(2);return 1===e?`$${n}`:`$${n} <span class="people-count">(√∑${e} Incl. You)</span>`})()}\n                    </span>\n                  </div>\n                  ${a<n.items.length-1?'<hr class="member-bill-divider">':""}\n                </div>\n              `).join("")}\n                \n              ${n.birthdayShare>0?`\n                <div class="member-bill-item-container birthday-share-item">\n                  <div class="birthday-share-header">\n                    <span class="birthday-share-icon">üéÇ</span>\n                    <span class="birthday-share-title">Birthday Contribution</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Helping to celebrate</span>\n                    <span class="member-bill-row-value">${billData?.birthdayPerson||"Birthday person"}'s special day</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Your contribution</span>\n                    <span class="member-bill-row-value birthday-contribution">+$${n.birthdayShare.toFixed(2)}</span>\n                  </div>\n                </div>\n                `:""}\n              \n              ${!n.isBirthdayPerson&&billData?.birthdayPerson&&memberData[billData.birthdayPerson]?`\n                <div class="member-bill-item-container birthday-person-breakdown">\n                  <div class="birthday-breakdown-header">\n                    <span class="birthday-breakdown-title">What ${billData.birthdayPerson} Ordered</span>\n                  </div>\n                  <div class="birthday-person-items-reference">\n                    ${memberData[billData.birthdayPerson].items.map(e=>`\n                      <div class="birthday-reference-item">\n                        <span class="birthday-reference-name">${e.name}</span>\n                      </div>\n                    `).join("")}\n                    ${0===memberData[billData.birthdayPerson].items.length?'<span class="no-items-reference">No items ordered</span>':""}\n                  </div>\n                </div>\n                `:""}\n            </div>\n            \n            <hr class="member-bill-solid-divider">\n            \n            <h3 class="member-bill-section-title">Amount Breakdown</h3>\n            <div class="total-section animate-staggered">\n              <div class="member-bill-row">\n                <span class="member-bill-row-label">Subtotal</span>\n                <span class="member-bill-row-value">${n.breakdown.subtotal}</span>\n              </div>\n              ${parseFloat(n.breakdown.serviceCharge.replace("$",""))>0?`\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">Service Charge (${n.serviceChargeRate})</span>\n                  <span class="member-bill-row-value">${n.breakdown.serviceCharge}</span>\n                </div>\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">After Service</span>\n                  <span class="member-bill-row-value">${n.breakdown.afterService}</span>\n                </div>\n                `:""}\n              ${parseFloat(n.breakdown.discount.replace("$",""))>0?`\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">Discount${n.discount?` (${n.discount})`:""}</span>\n                  <span class="member-bill-row-value">${n.breakdown.discount}</span>\n                </div>\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">After Discount</span>\n                  <span class="member-bill-row-value">${n.breakdown.afterDiscount}</span>\n                </div>\n                `:""}\n              ${parseFloat(n.breakdown.gst.replace("$",""))>0?`\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">GST (${"singapore"===n.taxProfile?"9%":"malaysia"===n.taxProfile?"6%":"9%"})</span>\n                  <span class="member-bill-row-value">${n.breakdown.gst}</span>\n                </div>\n                `:""}\n            </div>\n          </div>\n          \n          ${e===payerName||n.isBirthdayPerson?n.isBirthdayPerson?'\n            <div class="birthday-celebration-message modal-fade-in" style="animation-delay: 0.3s; text-align: center; padding: 20px;">\n              <h3>üéÇ Happy Birthday!</h3>\n              <p>Your friends are treating you today!</p>\n            </div>\n          ':'\n            <button id="showPayerStatsBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.3s;">\n              View Payment Tracking\n            </button>\n          ':`\n            ${paymentStatus[e]?.hasPaid?'\n              <div class="payment-status-indicator paid modal-fade-in" style="animation-delay: 0.3s;">\n                <span class="payment-status-text">‚úì Payment Confirmed</span>\n              </div>\n            ':'\n              <div class="bill-result-button-div">\n              <button id="showPayNowBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.3s;">\n                Show PayNow QR Code\n              </button>\n              <button id="havePaidBtn" class="action-button secondary-button modal-fade-in" style="animation-delay: 0.4s;">\n                I Have Paid!\n              </button>\n              </div>\n            '}\n          `}\n        `;const a=document.getElementById("showPayNowBtn");a&&a.addEventListener("click",()=>{showPayNowQR(e)});const s=document.getElementById("havePaidBtn");s&&s.addEventListener("click",()=>{showPaymentConfirmation(e)});const i=document.getElementById("showPayerStatsBtn");i&&i.addEventListener("click",()=>{showPayerTracking(e)})}t.offsetHeight}else s.textContent=`Member Data Not Found - ${e}`,o.innerHTML=`\n        <div class="error-message" style="text-align: center; padding: 20px;">\n          <p>Unable to load data for ${e}</p>\n          <p>Please try refreshing the page.</p>\n        </div>\n      `}o.children.length>0?(Array.from(o.children).forEach(e=>{e.classList.add("modal-fade-out")}),setTimeout(()=>{i()},300)):i(),window.addEventListener("resize",i),t.classList.add("active"),n.classList.add("active"),a&&(a.onclick=closeShareModal),n.onclick=closeShareModal}function showPayNowQR(e){if(isDesktopMode())return;const t=document.querySelector(".member-bill-modal-body"),n=document.querySelector(".member-bill-modal .modal-header h2"),a=memberData[e];Array.from(t.children).forEach(e=>{e.classList.add("modal-fade-out")}),setTimeout(()=>{const s=e===payerName?`üí∏ ${e}`:e;n.textContent=`PayNow - ${s}`;const o="singapore"===a.taxProfile;t.innerHTML=`\n      <div class="paynow-container modal-fade-in">\n        ${o?`\n        <div class="paynow-qr-container" id="paynow-qr-container">\n          \x3c!-- QR code will be generated here --\x3e\n          <img src="https://www.sgqrcode.com/paynow?mobile=${a.paymentInfo.phoneNumber}&uen=&editable=1&amount=${a.paymentInfo.amount.replace("$","")}&expiry=${(new Date).toISOString().split("T")[0].replace(/-/g,"%2F")}%2023%3A59&ref_id=${e+"%20-%20SettleLah!%20Bill"}&company=" alt="PayNow QR Code">\n        </div>\n        <button id="downloadQRBtn" class="download-qr-btn modal-fade-in" style="animation-delay: 0.4s;">\n          <svg xmlns="http://www.w3.org/2000/svg" fill="#ffffff" width="800px" height="800px" viewBox="0 0 24 24" id="download-5" class="icon line"><polyline id="primary" points="15 14 12 17 9 14" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/><path id="primary-2" data-name="primary" d="M12,17V3M4,17v3a1,1,0,0,0,1,1H19a1,1,0,0,0,1-1V17" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/></svg>\n          Download QR\n        </button>\n        <div class="paynow-instructions" style="animation-delay: 0.2s;">\n          <p> Please pay <b class="paynow-amount">${a.paymentInfo.amount}</b> to <b class="paynow-name" >${a.paymentInfo.name} (${a.paymentInfo.phoneNumber})</b>.</p>\n          <p>Scan the QR code to complete transfer or copy the phone number to start transfer.</p>\n        </div>\n        <div class="bill-result-button-div">\n        <button id="copyPhoneBtn" class="action-button secondary-button modal-fade-in" style="animation-delay: 0.3s;">\n          Copy Phone Number\n        </button>\n        `:`\n        <div class="paynow-instructions" style="animation-delay: 0.2s;">\n          <p>PayNow is only available in Singapore.</p>\n          <p>Please pay <b class="paynow-amount">${a.paymentInfo.amount}</b> to <b class="paynow-name" >${a.paymentInfo.name} (${a.paymentInfo.phoneNumber})</b> using another payment method.</p>\n        </div>\n        <div class="bill-result-button-div">\n        <button id="copyPhoneBtn" class="action-button secondary-button modal-fade-in" style="animation-delay: 0.3s;">\n          Copy Phone Number\n        </button>\n        `}\n        </div>\n      </div>\n      \n      <button id="backToDetailBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.4s;">\n        Back to Detail\n      </button>\n    `;const i=document.getElementById("copyPhoneBtn"),r=document.getElementById("backToDetailBtn");i&&i.addEventListener("click",()=>{navigator.clipboard.writeText(a.paymentInfo.phoneNumber).then(()=>{const e=document.createElement("div");e.textContent="Phone number copied!",e.className="toast-notification",document.body.appendChild(e),setTimeout(()=>{e.classList.add("toast-fadeout"),setTimeout(()=>{document.body.removeChild(e)},500)},2e3)}).catch(e=>{console.error("Failed to copy phone number: ",e)})}),r&&r.addEventListener("click",()=>{showShareModal(e)});const l=document.getElementById("downloadQRBtn");l&&l.addEventListener("click",()=>{const t=document.querySelector(".paynow-qr-container img");t&&downloadQRCode(t,e)})},300)}function showPayerTracking(e){const t=document.querySelector(".member-bill-modal-body"),n=document.querySelector(".member-bill-modal .modal-header h2");Array.from(t.children).forEach(e=>{e.classList.add("modal-fade-out")}),setTimeout(()=>{const a=e===payerName?`üí∏ ${e}`:e;n.textContent=`Payment Tracking - ${a}`,t.innerHTML=`\n      <div class="payer-tracking-container modal-fade-in">\n        <div class="payment-summary-mobile">\n          <div class="summary-stats">\n            <div class="stat-card paid-stat">\n              <div class="stat-number">${getPaidMembersCount()}</div>\n              <div class="stat-label">Paid</div>\n            </div>\n            <div class="stat-card pending-stat">\n              <div class="stat-number">${getPendingMembersCount()}</div>\n              <div class="stat-label">Pending</div>\n            </div>\n            <div class="stat-card amount-stat">\n              <div class="stat-number">${getOutstandingAmount()}</div>\n              <div class="stat-label">Outstanding</div>\n            </div>\n          </div>\n          \n          <div class="progress-bar-container" style="animation-delay: 0.2s;">\n            <div class="progress-bar">\n              <div class="progress-fill" style="width: ${getPaymentProgress()}%"></div>\n            </div>\n            <div class="progress-text">${getPaymentProgress()}% Complete</div>\n          </div>\n        </div>\n        \n        <div class="members-status-list-mobile" style="animation-delay: 0.3s;">\n          <h4>Member Payment Status</h4>\n          ${getMembersStatusList()}\n        </div>\n      </div>\n      \n      ${"$0.00"!==memberData[e]?.totalAmount?'\n      <button id="backToDetailBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.4s;">\n        Back to Your Bill\n      </button>\n      ':""}\n    `;const s=document.getElementById("backToDetailBtn");s&&s.addEventListener("click",()=>{showShareModal(e)})},300)}function closeShareModal(){const e=document.getElementById("memberbillModal"),t=document.getElementById("memberbillOverlay");e.style.transition="bottom 0.3s ease-in",e.style.bottom="-100%",t.style.transition="opacity 0.3s ease-in",t.style.opacity="0",setTimeout(()=>{e.classList.remove("active"),t.classList.remove("active");const n=document.querySelector(".member-bill-modal-body");n&&(n.innerHTML=""),e.style.transition="",e.style.bottom="",t.style.transition="",t.style.opacity=""},300)}function showPaymentConfirmation(e){const t=document.getElementById("paymentConfirmModal"),n=document.getElementById("paymentConfirmOverlay"),a=document.querySelector(".payment-confirm-close-modal"),s=document.getElementById("confirmPaymentBtn"),o=document.getElementById("cancelPaymentBtn");t.classList.add("active"),n.classList.add("active");const i=()=>{t.classList.remove("active"),n.classList.remove("active")};a.onclick=i,o.onclick=i,n.onclick=i,s.onclick=()=>{updatePaymentStatus(e,!0),i()}}async function updatePaymentStatus(e,t){try{const n=await fetch(`/api/bills/${billId}/payment-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({memberName:e,hasPaid:t})}),a=await n.json();a.success?(paymentStatus[e]=a.paymentStatus,updateMemberAvatarStatus(e,t),document.getElementById("memberbillModal").classList.contains("active")&&showShareModal(e),t&&checkPaymentCompletion()&&setTimeout(()=>{showCompletionCelebration()},1e3),showToast(t?`${e} marked as paid!`:`${e} payment status updated!`)):showToast("Failed to update payment status. Please try again.")}catch(e){console.error("Error updating payment status:",e),showToast("Error updating payment status. Please try again.")}}function updateMemberAvatarStatus(e,t){document.querySelectorAll(`.member-avatar-wrapper[data-name="${e}"]`).forEach(e=>{const n=e.querySelector(".member-avatar");if(t){if(!n.querySelector(".paid-indicator")){const e=document.createElement("div");e.className="paid-indicator",e.innerHTML="‚úì",n.appendChild(e),n.classList.add("paid")}}else{const e=n.querySelector(".paid-indicator");e&&(e.remove(),n.classList.remove("paid"))}})}function refreshAllPaymentStatuses(){billData.members&&billData.members.forEach(e=>{const t=paymentStatus[e.name]?.hasPaid||!1;updateMemberAvatarStatus(e.name,t)})}function getPaidMembersCount(){if(!billData.members)return 0;return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).filter(e=>(billData.totals[e.name]||0)>0).filter(e=>paymentStatus[e.name]?.hasPaid).length}function getPendingMembersCount(){if(!billData.members)return 0;return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).filter(e=>(billData.totals[e.name]||0)>0).filter(e=>!paymentStatus[e.name]?.hasPaid).length}function getOutstandingAmount(){if(!billData.members||!billData.totals)return"$0.00";let e=0;return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).forEach(t=>{const n=billData.totals[t.name]||0;n>0&&!paymentStatus[t.name]?.hasPaid&&(e+=n)}),`$${e.toFixed(2)}`}function getPaymentProgress(){if(!billData.members)return 0;const e=billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).filter(e=>(billData.totals[e.name]||0)>0);if(0===e.length)return 100;const t=e.filter(e=>paymentStatus[e.name]?.hasPaid).length;return Math.round(t/e.length*100)}function getMembersStatusList(){if(!billData.members||!billData.totals)return"";return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).filter(e=>(billData.totals[e.name]||0)>0).map(e=>{const t=e.name,n=billData.totals[t]||0,a=paymentStatus[t]?.hasPaid||!1,s=a?"paid":"pending",o=a?"Paid":"Pending";return`\n      <div class="member-status-item ${s}">\n        <div class="member-status-info">\n          <div class="member-status-name">\n            <span class="status-icon">${a?"‚úì":"‚è≥"}</span>\n            ${t}\n          </div>\n          <div class="member-status-amount">$${n.toFixed(2)}</div>\n        </div>\n        <div class="member-status-badge ${s}">\n          ${o}\n        </div>\n      </div>\n    `}).join("")}function createConfetti(){const e=Date.now()+3e3;confetti({particleCount:100,spread:70,origin:{x:.2,y:.6}}),confetti({particleCount:100,spread:70,origin:{x:.8,y:.6}});const t=setInterval(()=>{Date.now()>e?clearInterval(t):confetti({particleCount:50,spread:60,origin:{x:Math.random(),y:.5*Math.random()+.5}})},250);setTimeout(()=>{confetti({particleCount:200,spread:100,origin:{x:.5,y:.5}})},1e3)}function showCompletionCelebration(){const e=document.createElement("div");e.className="completion-celebration-container",e.innerHTML='\n  <div class="completion-celebration">\n    <span class="celebration-emoji">\n    <img src="/assets/finish-celebration.svg" />\n    </span>\n    <h2>Congratulations!</h2>\n    <p>Everyone has finished paying the bill!<br>All payments have been completed successfully.</p>\n    <button onclick="closeCompletionCelebration(this)">Awesome!</button>\n  </div>\n  ',document.body.appendChild(e),createConfetti()}function closeCompletionCelebration(e){const t=e.parentElement,n=t.parentElement;t.style.transform="translate(-50%, -50%) scale(0.8)",t.style.opacity="0",t.style.transition="all 0.3s ease",n.style.opacity="0",n.style.transition="opacity 0.3s ease",setTimeout(()=>{document.body.removeChild(n)},300)}function checkPaymentCompletion(){if(!billData.members)return!1;const e=billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson);if(0===e.length)return!1;return e.every(e=>paymentStatus[e.name]?.hasPaid)}function downloadQRCode(e,t){try{const n=document.createElement("canvas"),a=n.getContext("2d"),s=new Image;s.crossOrigin="anonymous",s.onload=function(){n.width=s.width,n.height=s.height,a.fillStyle="white",a.fillRect(0,0,n.width,n.height),a.drawImage(s,0,0),n.toBlob(function(e){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=`SettleLah-PayNow-${t||"QR"}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)},"image/png")},s.onerror=function(){const n=document.createElement("a");n.href=e.src,n.download=`SettleLah-PayNow-${t||"QR"}.png`,n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n)},s.src=e.src}catch(e){console.error("Error downloading QR code:",e),alert("Unable to download QR code. Please try right-clicking and saving the image.")}}function roundToNearest5Cents(e){"string"==typeof e&&(e=parseFloat(e));const t=(e=parseFloat(e.toFixed(2)))-Math.floor(e),n=Math.round(100*t),a=n%10;if(a<5){return(e-a/100).toFixed(2)}if(5===a)return e.toFixed(2);return(e+(10*Math.ceil(n/10)-n)/100).toFixed(2)}function renderBillData(e){billData=e,payerName=e.paynowName||"",paymentStatus=e.paymentStatus||{},!payerName&&e.members&&e.members.length>0&&(payerName=e.members[0].name);const t=(e,t=!1,n=!0)=>{const a="number"==typeof e?e:parseFloat(e);return t&&n?`$${roundToNearest5Cents(a)}`:`$${a.toFixed(2)}`},n=e.timestamp,a=new Date(n),s=a.toLocaleDateString("en-SG",{year:"numeric",month:"short",day:"numeric"}),o=a.toLocaleTimeString("en-SG",{hour:"2-digit",minute:"2-digit",hour12:!0});if(!document.getElementById("successReceipt"))return;const i=document.querySelector(".successSettleMatter"),r=document.querySelector(".successDateTime"),l=document.querySelector(".successItemCount"),d=document.querySelector(".successSubtotal"),c=document.querySelector(".successServiceCharge"),m=document.querySelector(".serviceChargeRow"),b=document.querySelector(".serviceChargeRate"),u=document.querySelector(".successAfterService"),p=document.querySelector(".afterServiceRow"),y=document.querySelector(".successDiscount"),h=document.querySelector(".discountRow"),v=document.querySelector(".successAfterDiscount"),g=document.querySelector(".afterDiscountRow"),w=document.querySelector(".successGST"),f=document.querySelector(".gstRow"),$=document.querySelector(".gstRate"),C=document.querySelector(".successAmount"),P=document.querySelector(".successOriginalAmount"),S=document.querySelector(".originalAmountRow");if(i&&(i.textContent=e.settleMatter?e.settleMatter:"No One Ask!"),r&&(r.textContent=s+" "+o),l&&(l.textContent=e.dishes?e.dishes.length:0),d&&(d.textContent=t(e.breakdown.subtotal)),e.settleMatter?document.title=`SettleLah - ${e.settleMatter} Bill Details`:document.title="SettleLah - No One Ask! Bill Details",c&&m&&(e.breakdown.serviceCharge>0?(c.textContent=t(e.breakdown.serviceCharge),m.style.display="",b&&(b.textContent=e.serviceChargeRate)):m.style.display="none"),u&&p&&(e.breakdown.serviceCharge>0?(u.textContent=t(e.breakdown.afterService),p.style.display=""):p.style.display="none"),y&&h)if(e.breakdown.discountAmount>0){y.textContent=t(e.breakdown.discountAmount),h.style.display="";const n=h.querySelector(".discount-rate");n&&e.discount?n.textContent=`(${e.discount})`:n&&(n.textContent="")}else h.style.display="none";if(v&&g&&(e.breakdown.discountAmount>0?(v.textContent=t(e.breakdown.afterDiscount),g.style.display=""):g.style.display="none"),w&&f&&(e.breakdown.gst>0?(w.textContent=t(e.breakdown.gst),f.style.display="",$&&($.textContent=e.gstRate||"9%")):f.style.display="none"),P&&S&&C){const t=e.breakdown.total.toFixed(2),n=roundToNearest5Cents(t);t!==n?(P.textContent=`$${t}`,S.style.display="",C.textContent=n):(S.style.display="none",C.textContent=n)}else C&&(C.textContent=roundedTotal);if(e.members&&Array.isArray(e.members)){const t=[...e.members];payerName&&!t.some(e=>e.name===payerName)&&t.push({name:payerName,avatar:"custom-payer"}),createMemberData(e),updateGroupMembers(t),setTimeout(()=>{refreshAllPaymentStatuses()},200)}}function createMemberData(e){if(memberData={},!e.members||!e.perPersonBreakdown||!e.dishes)return;const t=(e,t=!1,n=!1)=>{const a="number"==typeof e?e:parseFloat(e);return t&&n?`$${roundToNearest5Cents(a)}`:`$${a.toFixed(2)}`};e.members.forEach(n=>{const a=n.name,s=e.perPersonBreakdown[a];if(!s)return;const o=e.dishes.filter(e=>e.members.includes(a)).map(e=>({name:e.name,price:t(e.cost),sharedWith:e.members.filter(e=>e!==a).map(e=>`<span class="shared-member">${e}</span>`).join("")})),i=e.totals[a],r=i!==roundToNearest5Cents(i);memberData[a]={taxProfile:e.taxProfile||"singapore",serviceChargeRate:e.serviceChargeRate||"10%",discount:e.discount||"",isBirthdayPerson:e.birthdayPerson===a,birthdayShare:s.birthdayShare||0,originalAmount:r?t(i):null,totalAmount:t(i,!0),items:o,breakdown:{subtotal:t(s.subtotal),serviceCharge:t(s.serviceCharge),afterService:t(s.afterService),discount:t(s.discountAmount),afterDiscount:t(s.afterDiscount),gst:t(s.gst)},paymentInfo:{originalAmount:r?t(i):null,amount:t(i,!0),phoneNumber:e.paynowID||"",name:e.paynowName||"",settleMatter:e.settleMatter||"",uen:"N/A"}}}),payerName&&!e.members.some(e=>e.name===payerName)&&(memberData[payerName]={totalAmount:"$0.00",items:[],breakdown:{subtotal:"$0.00",serviceCharge:"$0.00",afterService:"$0.00",discount:"$0.00",afterDiscount:"$0.00",gst:"$0.00"},discount:e.discount||"",serviceChargeRate:e.serviceChargeRate||"10%",gstRate:e.gstRate||"9%",taxProfile:e.taxProfile||"singapore",paymentInfo:{originalAmount:null,amount:"$0.00",phoneNumber:e.paynowID||"",name:e.paynowName||"",settleMatter:e.settleMatter||"",uen:"N/A"}})}function updateGroupMembers(e){const t=document.getElementById("groupMembers");if(!t)return;t.innerHTML="";const n=e.filter(e=>{const t=memberData[e.name];return!t||(e.name===payerName||(billData?.birthdayPerson===e.name||"$0.00"!==t.totalAmount))}),a=document.querySelector(".favourite-group-section");a&&(a.style.opacity="0");let s=n.length;function o(){if(s--,0===s&&a){a.style.opacity="1",a.style.transition="opacity 0.5s ease";const e=document.getElementById("bill-content"),t=document.getElementById("bill-content");e&&(e.classList.add("visible"),setTimeout(()=>{t&&t.classList.add("ready")},4500));const n=document.getElementById("loading");n.classList.add("fade-out"),n.classList.add("hidden"),setTimeout(()=>{refreshAllPaymentStatuses()},500),setTimeout(()=>{checkPaymentCompletion()&&showCompletionCelebration()},1500)}}n.forEach((e,n)=>{const a=document.createElement("div");a.className="member-avatar-wrapper",a.setAttribute("data-name",e.name);const s=.4+.2*n;a.style.animation=`fadeInUp 0.4s ${s}s ease forwards`;const i=e.avatar||Math.floor(9*Math.random())+1,r=paymentStatus[e.name]?.hasPaid||!1,l=billData?.birthdayPerson===e.name;a.innerHTML=`\n      <div class="member-avatar ${r?"paid":""} ${l?"birthday-person":""}">\n        <img src="/assets/cat-icon/cat-${i}.svg" alt="Cat avatar" class="cat-avatar-img" />\n        ${r?'<div class="paid-indicator">‚úì</div><span class="paid-label">Paid</span>':""}\n      </div>\n      <div class="member-name ${l?"birthday-person":""}">${e.name===payerName?"üí∏ ":""}${l?"üéÇ ":""}${e.name}</div>\n    `;const d=new Image;d.onload=o,d.onerror=o,d.src=`/assets/cat-icon/cat-${i}.svg`,a.addEventListener("click",function(){showShareModal(e.name)}),t.appendChild(a)})}function showError(e,t="generic"){const n=document.getElementById("loading");n.classList.add("fade-out"),setTimeout(()=>{n.classList.add("hidden");document.getElementById("error-message").textContent=e;const a=document.getElementById("error-retry-btn");"expired"===t||"invalid"===t?(a.textContent="Return to Home",a.onclick=()=>window.location.href="/"):(a.textContent="Try Again",a.onclick=()=>window.location.reload());document.getElementById("error-container").classList.add("visible");const s=document.getElementById("bill-content"),o=document.getElementById("bill-content-footer");s&&s.classList.contains("visible")&&s.classList.remove("visible"),o&&o.classList.contains("visible")&&o.classList.remove("visible")},300)}function isRunningAsPWA(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone}function handleShareBill(){const e=window.location.href,t=document.querySelector(".successSettleMatter")?.textContent||"SettleLah Bill",n={title:`SettleLah! - ${t}`,text:`SettleLah! about ${t}`,url:e};navigator.share&&navigator.canShare&&navigator.canShare(n)?navigator.share(n).then(()=>{showToast("Bill shared successfully!")}).catch(t=>{"AbortError"!==t.name&&copyToClipboard(e)}):copyToClipboard(e)}function copyToClipboard(e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{showToast("Bill URL copied to clipboard!")}).catch(()=>{fallbackCopyToClipboard(e)}):fallbackCopyToClipboard(e)}function fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),showToast("Bill URL copied to clipboard!")}catch(e){showToast("Unable to copy URL. Please copy manually.")}finally{document.body.removeChild(t)}}function showToast(e){const t=document.querySelector(".toast-notification");t&&t.remove();const n=document.createElement("div");n.textContent=e,n.className="toast-notification",document.body.appendChild(n),setTimeout(()=>{n.classList.add("toast-fadeout"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},500)},2500)}document.addEventListener("DOMContentLoaded",function(){document.getElementById("error-container").classList.remove("visible"),document.getElementById("loading").classList.remove("hidden");const e=window.location.pathname.split("/");if(billId=e[e.length-1],!billId)return void showError("No bill ID found in URL","invalid");if(!/^[a-z0-9]+-[a-z0-9]+-[a-z0-9]+$/i.test(billId))return void showError("Invalid bill ID format","invalid");fetch(`/result/${billId}`,{headers:{Accept:"application/json"}}).then(e=>{if(410===e.status)throw new Error("This bill has expired",{cause:"expired"});if(400===e.status)throw new Error("Invalid bill ID format",{cause:"invalid"});if(!e.ok)throw new Error("Bill not found or error fetching data");return e.json()}).then(e=>{setTimeout(()=>{renderBillData(e)},300)}).catch(e=>{const t=e.cause||"generic";showError(e.message,t)});const t=document.querySelectorAll(".member-avatar-wrapper"),n=document.querySelector(".drag-instructions");n&&n.classList.remove("animate-pulse"),t.forEach(e=>{e.addEventListener("click",function(){showShareModal(this.getAttribute("data-name"))})});const a=document.getElementById("share-bill-btn");a&&a.addEventListener("click",handleShareBill)}),window.onload=function(){const e=document.querySelector(".terminal-img"),t=document.querySelector(".terminal-img-top"),n=document.getElementById("successReceipt"),a=document.querySelector(".favourite-group-section"),s=document.querySelector(".success-footer-text-title"),o=document.querySelector(".settings-footer");n&&(n.style.animation="receipt 3s ease both"),e&&(e.style.animation="slideup 0.5s 4s ease both"),t&&(t.style.animation="slideup 0.5s 4s ease both"),a&&(a.style.opacity="1"),s&&(s.style.animation="fadeInUp 0.5s 0.2s ease forwards"),o&&(o.style.animation="fadeInUp 0.5s 0.4s ease forwards");document.querySelectorAll(".member-avatar-wrapper").forEach((e,t)=>{e.style.animation=`fadeInUp 0.4s ${.4+.2*t}s ease forwards`})},document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".copyrightYear");e&&(e.textContent=(new Date).getFullYear())}),window.onload=function(){isRunningAsPWA()&&(document.body.style.height="100vh")};
=======
document.addEventListener("touchstart",function(e){e.touches.length>1&&(e.preventDefault(),e.stopPropagation())},{passive:!1}),document.addEventListener("gesturestart",function(e){e.preventDefault()},{passive:!1}),function(){const e=window.matchMedia("(prefers-color-scheme: dark)");let t=localStorage.getItem("theme")||(e.matches?"dark":"light");const n=e=>{"dark"===e?(document.body.classList.add("dark-mode"),document.documentElement.classList.add("dark-mode")):(document.body.classList.remove("dark-mode"),document.documentElement.classList.remove("dark-mode")),localStorage.setItem("theme",e),t=e};n(t),e.addEventListener("change",e=>{localStorage.getItem("theme")||n(e.matches?"dark":"light")}),document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("button");function a(){e.innerHTML="dark"===t?'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" fill="currentColor"/>\n            <path fill-rule="evenodd" clip-rule="evenodd" d="M11 0H13V4.06189C12.6724 4.02104 12.3387 4 12 4C11.6613 4 11.3276 4.02104 11 4.06189V0ZM7.0943 5.68018L4.22173 2.80761L2.80752 4.22183L5.68008 7.09439C6.07016 6.55685 6.55674 6.07027 7.0943 5.68018ZM4.06189 11H0V13H4.06189C4.02104 12.6724 4 12.3387 4 12C4 11.6613 4.02104 11.3276 4.06189 11ZM5.68008 16.9056L2.80751 19.7782L4.22173 21.1924L7.0943 18.3198C6.55674 17.9297 6.07016 17.4431 5.68008 16.9056ZM11 19.9381V24H13V19.9381C12.6724 19.979 12.3387 20 12 20C11.6613 20 11.3276 19.979 11 19.9381ZM16.9056 18.3199L19.7781 21.1924L21.1923 19.7782L18.3198 16.9057C17.9297 17.4432 17.4431 17.9298 16.9056 18.3199ZM19.9381 13H24V11H19.9381C19.979 11.3276 20 11.6613 20 12C20 12.3387 19.979 12.6724 19.9381 13ZM18.3198 7.0943L21.1923 4.22183L19.7781 2.80762L16.9056 5.68008C17.4431 6.07016 17.9297 6.55674 18.3198 7.0943Z" fill="currentColor"/>\n           </svg>':'<img src="/assets/moon.svg" alt="Moon" width="20" height="20">'}e.setAttribute("id","theme-toggle"),e.setAttribute("aria-label","Toggle dark mode"),a(),e.addEventListener("click",function(){n("dark"===t?"light":"dark"),a()}),document.body.appendChild(e)})}();let memberData={},billData={},billId="",payerName="",paymentStatus={};function isDesktopMode(){return window.matchMedia("(min-width: 1100px)").matches}function showShareModal(e){const t=document.getElementById("memberbillModal"),n=document.getElementById("memberbillOverlay"),a=document.querySelector(".member-close-modal"),s=document.querySelector(".member-bill-modal .modal-header h2"),o=document.querySelector(".member-bill-modal-body");function i(){if(e&&memberData[e]){const n=memberData[e],a=isDesktopMode(),i=n.isBirthdayPerson;let r=e===payerName?`üí∏ ${e}`:e;if(i&&(r=`üéÇ ${e} (Birthday)`),s.textContent=`Settle Detail - ${r}`,a){t.classList.add("desktop-mode");const a="singapore"===n.taxProfile;if(e===payerName&&"$0.00"===n.totalAmount)return void showPayerTracking(e);o.innerHTML=`\n          <div class="desktop-layout">\n            <div class="member-bill-modal-details modal-fade-in">\n              <div style="text-align: center;">\n                <h2 class="member-bill-title">Settle Detail</h2>\n                <h1 class="member-bill-amount">${n.totalAmount}</h1>\n              </div>\n              \n              <hr class="member-bill-divider">\n              \n              <h3 class="member-bill-section-title">Items</h3>\n              <div class="animate-staggered">\n                ${n.items.map((e,t)=>`\n                  <div class="member-bill-item-container">\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Item Name</span>\n                      <span class="member-bill-row-value">${e.name}</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Shared With</span>\n                      <div class="shared-with-container">${e.sharedWith||"-"}</div>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Item Price</span>\n                      <span class="member-bill-row-value">${e.price}</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Price Per Person</span>\n                      <span class="member-bill-row-value">\n                        ${(()=>{const t=e.sharedWith?(e.sharedWith.match(/<span class="shared-member">/g)||[]).length+1:1,n=(parseFloat(e.price.replace("$",""))/t).toFixed(2);return 1===t?`$${n}`:`$${n} <span class="people-count">(√∑${t} Incl. You)</span>`})()}\n                      </span>\n                    </div>\n                    ${t<n.items.length-1?'<hr class="member-bill-divider">':""}\n                  </div>\n                `).join("")}\n                \n                ${n.birthdayShare>0?`\n                  <div class="member-bill-item-container birthday-share-item">\n                    <div class="birthday-share-header">\n                      <span class="birthday-share-icon">üéÇ</span>\n                      <span class="birthday-share-title">Birthday Contribution</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Helping to celebrate</span>\n                      <span class="member-bill-row-value">${billData?.birthdayPerson||"Birthday person"}'s special day</span>\n                    </div>\n                    <div class="member-bill-row">\n                      <span class="member-bill-row-label">Your contribution</span>\n                      <span class="member-bill-row-value birthday-contribution">+$${n.birthdayShare.toFixed(2)}</span>\n                    </div>\n                  </div>\n                  `:""}\n                \n                ${!n.isBirthdayPerson&&billData?.birthdayPerson&&memberData[billData.birthdayPerson]?`\n                  <div class="member-bill-item-container birthday-person-breakdown">\n                    <div class="birthday-breakdown-header">\n                      <span class="birthday-breakdown-title">What ${billData.birthdayPerson} Ordered</span>\n                    </div>\n                    <div class="birthday-person-items-reference">\n                      ${memberData[billData.birthdayPerson].items.map(e=>`\n                        <div class="birthday-reference-item">\n                          <span class="birthday-reference-name">${e.name}</span>\n                        </div>\n                      `).join("")}\n                      ${0===memberData[billData.birthdayPerson].items.length?'<span class="no-items-reference">No items ordered</span>':""}\n                    </div>\n                  </div>\n                  `:""}\n              </div>\n              \n              <hr class="member-bill-solid-divider">\n              \n              <h3 class="member-bill-section-title">Amount Breakdown</h3>\n              <div class="total-section animate-staggered">\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">Subtotal</span>\n                  <span class="member-bill-row-value">${n.breakdown.subtotal}</span>\n                </div>\n                ${parseFloat(n.breakdown.serviceCharge.replace("$",""))>0?`\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Service Charge (${n.serviceChargeRate})</span>\n                    <span class="member-bill-row-value">${n.breakdown.serviceCharge}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">After Service</span>\n                    <span class="member-bill-row-value">${n.breakdown.afterService}</span>\n                  </div>\n                  `:""}\n                ${parseFloat(n.breakdown.discount.replace("$",""))>0?`\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Discount${n.discount?` (${n.discount})`:""}</span>\n                    <span class="member-bill-row-value">${n.breakdown.discount}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">After Discount</span>\n                    <span class="member-bill-row-value">${n.breakdown.afterDiscount}</span>\n                  </div>\n                  `:""}\n                ${parseFloat(n.breakdown.gst.replace("$",""))>0?`\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">GST (${"singapore"===n.taxProfile?"9%":"malaysia"===n.taxProfile?"6%":"9%"})</span>\n                    <span class="member-bill-row-value">${n.breakdown.gst}</span>\n                  </div>\n                  `:""}\n              </div>\n            </div>\n            \n            ${e===payerName||n.isBirthdayPerson?n.isBirthdayPerson?'\n            <div class="birthday-celebration-panel modal-fade-in">\n              <div style="text-align: center; padding: 20px;">\n                <h2 class="celebration-title">üéÇ Happy Birthday!</h2>\n                <p class="celebration-message">Your friends are treating you today!</p>\n                <div class="birthday-gift-icon">üéÅ</div>\n                <p class="celebration-subtitle">Enjoy your special day!</p>\n              </div>\n            </div>\n            ':"$0.00"===n.totalAmount?`\n            <div class="payer-tracking-section modal-fade-in">\n              <div class="payment-summary-compact">\n                <div class="summary-stats">\n                  <div class="stat-card paid-stat">\n                    <div class="stat-number">${getPaidMembersCount()}</div>\n                    <div class="stat-label">Paid</div>\n                  </div>\n                  <div class="stat-card pending-stat">\n                    <div class="stat-number">${getPendingMembersCount()}</div>\n                    <div class="stat-label">Pending</div>\n                  </div>\n                  <div class="stat-card amount-stat">\n                    <div class="stat-number">${getOutstandingAmount()}</div>\n                    <div class="stat-label">Outstanding</div>\n                  </div>\n                </div>\n                \n                <div class="progress-bar-container">\n                  <div class="progress-bar">\n                    <div class="progress-fill" style="width: ${getPaymentProgress()}%"></div>\n                  </div>\n                  <div class="progress-text">${getPaymentProgress()}% Complete</div>\n                </div>\n              </div>\n              \n              <div class="members-status-list-compact">\n                <h4>Member Payment Status</h4>\n                ${getMembersStatusList()}\n              </div>\n            </div>\n            `:`\n            \n            \n            <div class="payer-tracking-section modal-fade-in">\n              <h2 class="paynow-title">Payment Tracking Dashboard</h2>\n              \n              <div class="payment-summary-compact">\n                <div class="summary-stats">\n                  <div class="stat-card paid-stat">\n                    <div class="stat-number">${getPaidMembersCount()}</div>\n                    <div class="stat-label">Paid</div>\n                  </div>\n                  <div class="stat-card pending-stat">\n                    <div class="stat-number">${getPendingMembersCount()}</div>\n                    <div class="stat-label">Pending</div>\n                  </div>\n                  <div class="stat-card amount-stat">\n                    <div class="stat-number">${getOutstandingAmount()}</div>\n                    <div class="stat-label">Outstanding</div>\n                  </div>\n                </div>\n                \n                <div class="progress-bar-container">\n                  <div class="progress-bar">\n                    <div class="progress-fill" style="width: ${getPaymentProgress()}%"></div>\n                  </div>\n                  <div class="progress-text">${getPaymentProgress()}% Complete</div>\n                </div>\n              </div>\n              \n              <div class="members-status-list-compact">\n                <h4>Member Payment Status</h4>\n                ${getMembersStatusList()}\n              </div>\n            </div>\n            `:`\n            <div class="paynow-section modal-fade-in">\n              <h2 class="paynow-title">Please Transfer to</h2>\n              ${a?`\n                <div class="paynow-qr-container" id="paynow-qr-container">\n                  <img src="https://www.sgqrcode.com/paynow?mobile=${n.paymentInfo.phoneNumber}&uen=&editable=1&amount=${n.paymentInfo.amount.replace("$","")}&expiry=${(new Date).toISOString().split("T")[0].replace(/-/g,"%2F")}%2023%3A59&ref_id=SettleLah-${n.paymentInfo.name+"%20"+n.paymentInfo.settleMatter||"SettleLah"}&company=" alt="PayNow QR Code" class="desktop-qr-code">\n                </div>\n                <button id="downloadQRBtn" class="download-qr-btn">\n                  <svg xmlns="http://www.w3.org/2000/svg" fill="#ffffff" width="800px" height="800px" viewBox="0 0 24 24" id="download-5" class="icon line"><polyline id="primary" points="15 14 12 17 9 14" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/><path id="primary-2" data-name="primary" d="M12,17V3M4,17v3a1,1,0,0,0,1,1H19a1,1,0,0,0,1-1V17" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/></svg>\n                  Download QR\n                </button>\n                <div class="paynow-instructions">\n                  <p>Please pay <b class="paynow-amount">${n.paymentInfo.amount}</b> to <b class="paynow-name">${n.paymentInfo.name} (${n.paymentInfo.phoneNumber})</b>.</p>\n                  <p>Scan the QR code to complete transfer or copy the phone number to start transfer.</p>\n                </div>\n                <div class="bill-result-button-div">\n                <button id="copyPhoneBtn" class="action-button secondary-button">\n                  Copy Phone Number\n                </button>\n                `:`\n                <div class="paynow-instructions">\n                  <p>Please pay <b class="paynow-amount">${n.paymentInfo.amount}</b> to <b class="paynow-name">${n.paymentInfo.name} (${n.paymentInfo.phoneNumber})</b> using DuitNow payment method.</p>\n                </div>\n                <div class="bill-result-button-div">\n                <button id="copyPhoneBtn" class="action-button secondary-button">\n                  Copy Phone Number\n                </button>\n                `}\n              \n              ${paymentStatus[e]?.hasPaid?'\n                <div class="payment-status-indicator paid">\n                  <span class="payment-status-text">‚úì Payment Confirmed</span>\n                </div>\n              ':'\n                <button id="havePaidBtn" class="action-button primary-button" style="margin-top: 15px;">\n                  I Have Paid!\n                </button>\n              '}\n              </div>\n            </div>\n            `}\n          </div>\n        `;const s=document.getElementById("copyPhoneBtn");s&&s.addEventListener("click",()=>{navigator.clipboard.writeText(n.paymentInfo.phoneNumber).then(()=>{const e=document.createElement("div");e.textContent="Phone number copied!",e.className="toast-notification",document.body.appendChild(e),setTimeout(()=>{e.classList.add("toast-fadeout"),setTimeout(()=>{document.body.removeChild(e)},500)},2e3)}).catch(e=>{console.error("Failed to copy phone number: ",e)})});const i=document.getElementById("havePaidBtn");i&&i.addEventListener("click",()=>{showPaymentConfirmation(e)});const r=document.getElementById("downloadQRBtn");r&&r.addEventListener("click",()=>{const t=document.querySelector("#paynow-qr-container img");t&&downloadQRCode(t,e)})}else{t.classList.remove("desktop-mode");if(e===payerName&&"$0.00"===n.totalAmount)return void showPayerTracking(e);o.innerHTML=`\n          <div class="member-bill-modal-details modal-fade-in">\n            <div style="text-align: center;">\n              <h2 class="member-bill-title">${e===payerName?"Your Bill Breakdown":"Settle Detail"}</h2>\n              <h1 class="member-bill-amount">${n.totalAmount}</h1>\n            </div>\n            \n            <hr class="member-bill-divider">\n            \n            <h3 class="member-bill-section-title">Items</h3>\n            <div class="animate-staggered">\n              ${n.items.map((t,a)=>`\n                <div class="member-bill-item-container">\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Item Name</span>\n                    <span class="member-bill-row-value">${t.name}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Shared With</span>\n                    <div class="shared-with-container">${t.sharedWith||(e===payerName?"Just You":"-")}</div>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Item Price</span>\n                    <span class="member-bill-row-value">${t.price}</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Price Per Person</span>\n                    <span class="member-bill-row-value">\n                      ${(()=>{const e=t.sharedWith?(t.sharedWith.match(/<span class="shared-member">/g)||[]).length+1:1,n=(parseFloat(t.price.replace("$",""))/e).toFixed(2);return 1===e?`$${n}`:`$${n} <span class="people-count">(√∑${e} Incl. You)</span>`})()}\n                    </span>\n                  </div>\n                  ${a<n.items.length-1?'<hr class="member-bill-divider">':""}\n                </div>\n              `).join("")}\n                \n              ${n.birthdayShare>0?`\n                <div class="member-bill-item-container birthday-share-item">\n                  <div class="birthday-share-header">\n                    <span class="birthday-share-icon">üéÇ</span>\n                    <span class="birthday-share-title">Birthday Contribution</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Helping to celebrate</span>\n                    <span class="member-bill-row-value">${billData?.birthdayPerson||"Birthday person"}'s special day</span>\n                  </div>\n                  <div class="member-bill-row">\n                    <span class="member-bill-row-label">Your contribution</span>\n                    <span class="member-bill-row-value birthday-contribution">+$${n.birthdayShare.toFixed(2)}</span>\n                  </div>\n                </div>\n                `:""}\n              \n              ${!n.isBirthdayPerson&&billData?.birthdayPerson&&memberData[billData.birthdayPerson]?`\n                <div class="member-bill-item-container birthday-person-breakdown">\n                  <div class="birthday-breakdown-header">\n                    <span class="birthday-breakdown-title">What ${billData.birthdayPerson} Ordered</span>\n                  </div>\n                  <div class="birthday-person-items-reference">\n                    ${memberData[billData.birthdayPerson].items.map(e=>`\n                      <div class="birthday-reference-item">\n                        <span class="birthday-reference-name">${e.name}</span>\n                      </div>\n                    `).join("")}\n                    ${0===memberData[billData.birthdayPerson].items.length?'<span class="no-items-reference">No items ordered</span>':""}\n                  </div>\n                </div>\n                `:""}\n            </div>\n            \n            <hr class="member-bill-solid-divider">\n            \n            <h3 class="member-bill-section-title">Amount Breakdown</h3>\n            <div class="total-section animate-staggered">\n              <div class="member-bill-row">\n                <span class="member-bill-row-label">Subtotal</span>\n                <span class="member-bill-row-value">${n.breakdown.subtotal}</span>\n              </div>\n              ${parseFloat(n.breakdown.serviceCharge.replace("$",""))>0?`\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">Service Charge (${n.serviceChargeRate})</span>\n                  <span class="member-bill-row-value">${n.breakdown.serviceCharge}</span>\n                </div>\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">After Service</span>\n                  <span class="member-bill-row-value">${n.breakdown.afterService}</span>\n                </div>\n                `:""}\n              ${parseFloat(n.breakdown.discount.replace("$",""))>0?`\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">Discount${n.discount?` (${n.discount})`:""}</span>\n                  <span class="member-bill-row-value">${n.breakdown.discount}</span>\n                </div>\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">After Discount</span>\n                  <span class="member-bill-row-value">${n.breakdown.afterDiscount}</span>\n                </div>\n                `:""}\n              ${parseFloat(n.breakdown.gst.replace("$",""))>0?`\n                <div class="member-bill-row">\n                  <span class="member-bill-row-label">GST (${"singapore"===n.taxProfile?"9%":"malaysia"===n.taxProfile?"6%":"9%"})</span>\n                  <span class="member-bill-row-value">${n.breakdown.gst}</span>\n                </div>\n                `:""}\n            </div>\n          </div>\n          \n          ${e===payerName||n.isBirthdayPerson?n.isBirthdayPerson?'\n            <div class="birthday-celebration-message modal-fade-in" style="animation-delay: 0.3s; text-align: center; padding: 20px;">\n              <h3>üéÇ Happy Birthday!</h3>\n              <p>Your friends are treating you today!</p>\n            </div>\n          ':'\n            <button id="showPayerStatsBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.3s;">\n              View Payment Tracking\n            </button>\n          ':`\n            ${paymentStatus[e]?.hasPaid?'\n              <div class="payment-status-indicator paid modal-fade-in" style="animation-delay: 0.3s;">\n                <span class="payment-status-text">‚úì Payment Confirmed</span>\n              </div>\n            ':'\n              <div class="bill-result-button-div">\n              <button id="showPayNowBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.3s;">\n                Show PayNow QR Code\n              </button>\n              <button id="havePaidBtn" class="action-button secondary-button modal-fade-in" style="animation-delay: 0.4s;">\n                I Have Paid!\n              </button>\n              </div>\n            '}\n          `}\n        `;const a=document.getElementById("showPayNowBtn");a&&a.addEventListener("click",()=>{showPayNowQR(e)});const s=document.getElementById("havePaidBtn");s&&s.addEventListener("click",()=>{showPaymentConfirmation(e)});const i=document.getElementById("showPayerStatsBtn");i&&i.addEventListener("click",()=>{showPayerTracking(e)})}t.offsetHeight}else s.textContent=`Member Data Not Found - ${e}`,o.innerHTML=`\n        <div class="error-message" style="text-align: center; padding: 20px;">\n          <p>Unable to load data for ${e}</p>\n          <p>Please try refreshing the page.</p>\n        </div>\n      `}o.children.length>0?(Array.from(o.children).forEach(e=>{e.classList.add("modal-fade-out")}),setTimeout(()=>{i()},300)):i(),window.addEventListener("resize",i),t.classList.add("active"),n.classList.add("active"),a&&(a.onclick=closeShareModal),n.onclick=closeShareModal}function showPayNowQR(e){if(isDesktopMode())return;const t=document.querySelector(".member-bill-modal-body"),n=document.querySelector(".member-bill-modal .modal-header h2"),a=memberData[e];Array.from(t.children).forEach(e=>{e.classList.add("modal-fade-out")}),setTimeout(()=>{const s=e===payerName?`üí∏ ${e}`:e;n.textContent=`PayNow - ${s}`;const o="singapore"===a.taxProfile;t.innerHTML=`\n      <div class="paynow-container modal-fade-in">\n        ${o?`\n        <div class="paynow-qr-container" id="paynow-qr-container">\n          \x3c!-- QR code will be generated here --\x3e\n          <img src="https://www.sgqrcode.com/paynow?mobile=${a.paymentInfo.phoneNumber}&uen=&editable=1&amount=${a.paymentInfo.amount.replace("$","")}&expiry=${(new Date).toISOString().split("T")[0].replace(/-/g,"%2F")}%2023%3A59&ref_id=${e+"%20-%20SettleLah!%20Bill"}&company=" alt="PayNow QR Code">\n        </div>\n        <button id="downloadQRBtn" class="download-qr-btn modal-fade-in" style="animation-delay: 0.4s;">\n          <svg xmlns="http://www.w3.org/2000/svg" fill="#ffffff" width="800px" height="800px" viewBox="0 0 24 24" id="download-5" class="icon line"><polyline id="primary" points="15 14 12 17 9 14" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/><path id="primary-2" data-name="primary" d="M12,17V3M4,17v3a1,1,0,0,0,1,1H19a1,1,0,0,0,1-1V17" style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5;"/></svg>\n          Download QR\n        </button>\n        <div class="paynow-instructions" style="animation-delay: 0.2s;">\n          <p> Please pay <b class="paynow-amount">${a.paymentInfo.amount}</b> to <b class="paynow-name" >${a.paymentInfo.name} (${a.paymentInfo.phoneNumber})</b>.</p>\n          <p>Scan the QR code to complete transfer or copy the phone number to start transfer.</p>\n        </div>\n        <div class="bill-result-button-div">\n        <button id="copyPhoneBtn" class="action-button secondary-button modal-fade-in" style="animation-delay: 0.3s;">\n          Copy Phone Number\n        </button>\n        `:`\n        <div class="paynow-instructions" style="animation-delay: 0.2s;">\n          <p>PayNow is only available in Singapore.</p>\n          <p>Please pay <b class="paynow-amount">${a.paymentInfo.amount}</b> to <b class="paynow-name" >${a.paymentInfo.name} (${a.paymentInfo.phoneNumber})</b> using another payment method.</p>\n        </div>\n        <div class="bill-result-button-div">\n        <button id="copyPhoneBtn" class="action-button secondary-button modal-fade-in" style="animation-delay: 0.3s;">\n          Copy Phone Number\n        </button>\n        `}\n        </div>\n      </div>\n      \n      <button id="backToDetailBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.4s;">\n        Back to Detail\n      </button>\n    `;const i=document.getElementById("copyPhoneBtn"),r=document.getElementById("backToDetailBtn");i&&i.addEventListener("click",()=>{navigator.clipboard.writeText(a.paymentInfo.phoneNumber).then(()=>{const e=document.createElement("div");e.textContent="Phone number copied!",e.className="toast-notification",document.body.appendChild(e),setTimeout(()=>{e.classList.add("toast-fadeout"),setTimeout(()=>{document.body.removeChild(e)},500)},2e3)}).catch(e=>{console.error("Failed to copy phone number: ",e)})}),r&&r.addEventListener("click",()=>{showShareModal(e)});const l=document.getElementById("downloadQRBtn");l&&l.addEventListener("click",()=>{const t=document.querySelector(".paynow-qr-container img");t&&downloadQRCode(t,e)})},300)}function showPayerTracking(e){const t=document.querySelector(".member-bill-modal-body"),n=document.querySelector(".member-bill-modal .modal-header h2");Array.from(t.children).forEach(e=>{e.classList.add("modal-fade-out")}),setTimeout(()=>{const a=e===payerName?`üí∏ ${e}`:e;n.textContent=`Payment Tracking - ${a}`,t.innerHTML=`\n      <div class="payer-tracking-container modal-fade-in">\n        <div class="payment-summary-mobile">\n          <div class="summary-stats">\n            <div class="stat-card paid-stat">\n              <div class="stat-number">${getPaidMembersCount()}</div>\n              <div class="stat-label">Paid</div>\n            </div>\n            <div class="stat-card pending-stat">\n              <div class="stat-number">${getPendingMembersCount()}</div>\n              <div class="stat-label">Pending</div>\n            </div>\n            <div class="stat-card amount-stat">\n              <div class="stat-number">${getOutstandingAmount()}</div>\n              <div class="stat-label">Outstanding</div>\n            </div>\n          </div>\n          \n          <div class="progress-bar-container" style="animation-delay: 0.2s;">\n            <div class="progress-bar">\n              <div class="progress-fill" style="width: ${getPaymentProgress()}%"></div>\n            </div>\n            <div class="progress-text">${getPaymentProgress()}% Complete</div>\n          </div>\n        </div>\n        \n        <div class="members-status-list-mobile" style="animation-delay: 0.3s;">\n          <h4>Member Payment Status</h4>\n          ${getMembersStatusList()}\n        </div>\n      </div>\n      \n      ${"$0.00"!==memberData[e]?.totalAmount?'\n      <button id="backToDetailBtn" class="action-button primary-button modal-fade-in" style="animation-delay: 0.4s;">\n        Back to Your Bill\n      </button>\n      ':""}\n    `;const s=document.getElementById("backToDetailBtn");s&&s.addEventListener("click",()=>{showShareModal(e)})},300)}function closeShareModal(){const e=document.getElementById("memberbillModal"),t=document.getElementById("memberbillOverlay");e.style.transition="bottom 0.3s ease-in",e.style.bottom="-100%",t.style.transition="opacity 0.3s ease-in",t.style.opacity="0",setTimeout(()=>{e.classList.remove("active"),t.classList.remove("active");const n=document.querySelector(".member-bill-modal-body");n&&(n.innerHTML=""),e.style.transition="",e.style.bottom="",t.style.transition="",t.style.opacity=""},300)}function showPaymentConfirmation(e){const t=document.getElementById("paymentConfirmModal"),n=document.getElementById("paymentConfirmOverlay"),a=document.querySelector(".payment-confirm-close-modal"),s=document.getElementById("confirmPaymentBtn"),o=document.getElementById("cancelPaymentBtn");t.classList.add("active"),n.classList.add("active");const i=()=>{t.classList.remove("active"),n.classList.remove("active")};a.onclick=i,o.onclick=i,n.onclick=i,s.onclick=()=>{updatePaymentStatus(e,!0),i()}}async function updatePaymentStatus(e,t){try{const n=await fetch(`/api/bills/${billId}/payment-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({memberName:e,hasPaid:t})}),a=await n.json();a.success?(paymentStatus[e]=a.paymentStatus,updateMemberAvatarStatus(e,t),document.getElementById("memberbillModal").classList.contains("active")&&showShareModal(e),t&&checkPaymentCompletion()&&setTimeout(()=>{showCompletionCelebration()},1e3),showToast(t?`${e} marked as paid!`:`${e} payment status updated!`)):showToast("Failed to update payment status. Please try again.")}catch(e){console.error("Error updating payment status:",e),showToast("Error updating payment status. Please try again.")}}function updateMemberAvatarStatus(e,t){document.querySelectorAll(`.member-avatar-wrapper[data-name="${e}"]`).forEach(e=>{const n=e.querySelector(".member-avatar");if(t){if(!n.querySelector(".paid-indicator")){const e=document.createElement("div");e.className="paid-indicator",e.innerHTML="‚úì",n.appendChild(e),n.classList.add("paid")}}else{const e=n.querySelector(".paid-indicator");e&&(e.remove(),n.classList.remove("paid"))}})}function refreshAllPaymentStatuses(){billData.members&&billData.members.forEach(e=>{const t=paymentStatus[e.name]?.hasPaid||!1;updateMemberAvatarStatus(e.name,t)})}function getPaidMembersCount(){if(!billData.members)return 0;return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).filter(e=>paymentStatus[e.name]?.hasPaid).length}function getPendingMembersCount(){if(!billData.members)return 0;return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).filter(e=>!paymentStatus[e.name]?.hasPaid).length}function getOutstandingAmount(){if(!billData.members||!billData.totals)return"$0.00";let e=0;return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).forEach(t=>{if(!paymentStatus[t.name]?.hasPaid){const n=billData.totals[t.name]||0;e+=n}}),`$${e.toFixed(2)}`}function getPaymentProgress(){if(!billData.members)return 0;const e=billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson);if(0===e.length)return 100;const t=e.filter(e=>paymentStatus[e.name]?.hasPaid).length;return Math.round(t/e.length*100)}function getMembersStatusList(){if(!billData.members||!billData.totals)return"";return billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson).map(e=>{const t=e.name,n=billData.totals[t]||0,a=paymentStatus[t]?.hasPaid||!1,s=a?"paid":"pending",o=a?"Paid":"Pending";return`\n      <div class="member-status-item ${s}">\n        <div class="member-status-info">\n          <div class="member-status-name">\n            <span class="status-icon">${a?"‚úì":"‚è≥"}</span>\n            ${t}\n          </div>\n          <div class="member-status-amount">$${n.toFixed(2)}</div>\n        </div>\n        <div class="member-status-badge ${s}">\n          ${o}\n        </div>\n      </div>\n    `}).join("")}function createConfetti(){const e=Date.now()+3e3;confetti({particleCount:100,spread:70,origin:{x:.2,y:.6}}),confetti({particleCount:100,spread:70,origin:{x:.8,y:.6}});const t=setInterval(()=>{Date.now()>e?clearInterval(t):confetti({particleCount:50,spread:60,origin:{x:Math.random(),y:.5*Math.random()+.5}})},250);setTimeout(()=>{confetti({particleCount:200,spread:100,origin:{x:.5,y:.5}})},1e3)}function showCompletionCelebration(){const e=document.createElement("div");e.className="completion-celebration-container",e.innerHTML='\n  <div class="completion-celebration">\n    <span class="celebration-emoji">\n    <img src="/assets/finish-celebration.svg" />\n    </span>\n    <h2>Congratulations!</h2>\n    <p>Everyone has finished paying the bill!<br>All payments have been completed successfully.</p>\n    <button onclick="closeCompletionCelebration(this)">Awesome!</button>\n  </div>\n  ',document.body.appendChild(e),createConfetti()}function closeCompletionCelebration(e){const t=e.parentElement,n=t.parentElement;t.style.transform="translate(-50%, -50%) scale(0.8)",t.style.opacity="0",t.style.transition="all 0.3s ease",n.style.opacity="0",n.style.transition="opacity 0.3s ease",setTimeout(()=>{document.body.removeChild(n)},300)}function checkPaymentCompletion(){if(!billData.members)return!1;const e=billData.members.filter(e=>e.name!==payerName&&e.name!==billData.birthdayPerson);if(0===e.length)return!1;return e.every(e=>paymentStatus[e.name]?.hasPaid)}function downloadQRCode(e,t){try{const n=document.createElement("canvas"),a=n.getContext("2d"),s=new Image;s.crossOrigin="anonymous",s.onload=function(){n.width=s.width,n.height=s.height,a.fillStyle="white",a.fillRect(0,0,n.width,n.height),a.drawImage(s,0,0),n.toBlob(function(e){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=`SettleLah-PayNow-${t||"QR"}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)},"image/png")},s.onerror=function(){const n=document.createElement("a");n.href=e.src,n.download=`SettleLah-PayNow-${t||"QR"}.png`,n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n)},s.src=e.src}catch(e){console.error("Error downloading QR code:",e),alert("Unable to download QR code. Please try right-clicking and saving the image.")}}function roundToNearest5Cents(e){"string"==typeof e&&(e=parseFloat(e));const t=(e=parseFloat(e.toFixed(2)))-Math.floor(e),n=Math.round(100*t),a=n%10;if(a<5){return(e-a/100).toFixed(2)}if(5===a)return e.toFixed(2);return(e+(10*Math.ceil(n/10)-n)/100).toFixed(2)}function renderBillData(e){billData=e,payerName=e.paynowName||"",paymentStatus=e.paymentStatus||{},!payerName&&e.members&&e.members.length>0&&(payerName=e.members[0].name);const t=(e,t=!1,n=!0)=>{const a="number"==typeof e?e:parseFloat(e);return t&&n?`$${roundToNearest5Cents(a)}`:`$${a.toFixed(2)}`},n=e.timestamp,a=new Date(n),s=a.toLocaleDateString("en-SG",{year:"numeric",month:"short",day:"numeric"}),o=a.toLocaleTimeString("en-SG",{hour:"2-digit",minute:"2-digit",hour12:!0});if(!document.getElementById("successReceipt"))return;const i=document.querySelector(".successSettleMatter"),r=document.querySelector(".successDateTime"),l=document.querySelector(".successItemCount"),d=document.querySelector(".successSubtotal"),c=document.querySelector(".successServiceCharge"),m=document.querySelector(".serviceChargeRow"),b=document.querySelector(".serviceChargeRate"),u=document.querySelector(".successAfterService"),p=document.querySelector(".afterServiceRow"),y=document.querySelector(".successDiscount"),h=document.querySelector(".discountRow"),v=document.querySelector(".successAfterDiscount"),g=document.querySelector(".afterDiscountRow"),w=document.querySelector(".successGST"),f=document.querySelector(".gstRow"),$=document.querySelector(".gstRate"),C=document.querySelector(".successAmount"),P=document.querySelector(".successOriginalAmount"),S=document.querySelector(".originalAmountRow");if(i&&(i.textContent=e.settleMatter?e.settleMatter:"No One Ask!"),r&&(r.textContent=s+" "+o),l&&(l.textContent=e.dishes?e.dishes.length:0),d&&(d.textContent=t(e.breakdown.subtotal)),e.settleMatter?document.title=`SettleLah - ${e.settleMatter} Bill Details`:document.title="SettleLah - No One Ask! Bill Details",c&&m&&(e.breakdown.serviceCharge>0?(c.textContent=t(e.breakdown.serviceCharge),m.style.display="",b&&(b.textContent=e.serviceChargeRate)):m.style.display="none"),u&&p&&(e.breakdown.serviceCharge>0?(u.textContent=t(e.breakdown.afterService),p.style.display=""):p.style.display="none"),y&&h)if(e.breakdown.discountAmount>0){y.textContent=t(e.breakdown.discountAmount),h.style.display="";const n=h.querySelector(".discount-rate");n&&e.discount?n.textContent=`(${e.discount})`:n&&(n.textContent="")}else h.style.display="none";if(v&&g&&(e.breakdown.discountAmount>0?(v.textContent=t(e.breakdown.afterDiscount),g.style.display=""):g.style.display="none"),w&&f&&(e.breakdown.gst>0?(w.textContent=t(e.breakdown.gst),f.style.display="",$&&($.textContent=e.gstRate||"9%")):f.style.display="none"),P&&S&&C){const t=e.breakdown.total.toFixed(2),n=roundToNearest5Cents(t);t!==n?(P.textContent=`$${t}`,S.style.display="",C.textContent=n):(S.style.display="none",C.textContent=n)}else C&&(C.textContent=roundedTotal);if(e.members&&Array.isArray(e.members)){const t=[...e.members];payerName&&!t.some(e=>e.name===payerName)&&t.push({name:payerName,avatar:"custom-payer"}),createMemberData(e),updateGroupMembers(t),setTimeout(()=>{refreshAllPaymentStatuses()},200)}}function createMemberData(e){if(memberData={},!e.members||!e.perPersonBreakdown||!e.dishes)return;const t=(e,t=!1,n=!1)=>{const a="number"==typeof e?e:parseFloat(e);return t&&n?`$${roundToNearest5Cents(a)}`:`$${a.toFixed(2)}`};e.members.forEach(n=>{const a=n.name,s=e.perPersonBreakdown[a];if(!s)return;const o=e.dishes.filter(e=>e.members.includes(a)).map(e=>({name:e.name,price:t(e.cost),sharedWith:e.members.filter(e=>e!==a).map(e=>`<span class="shared-member">${e}</span>`).join("")})),i=e.totals[a],r=i!==roundToNearest5Cents(i);memberData[a]={taxProfile:e.taxProfile||"singapore",serviceChargeRate:e.serviceChargeRate||"10%",discount:e.discount||"",isBirthdayPerson:e.birthdayPerson===a,birthdayShare:s.birthdayShare||0,originalAmount:r?t(i):null,totalAmount:t(i,!0),items:o,breakdown:{subtotal:t(s.subtotal),serviceCharge:t(s.serviceCharge),afterService:t(s.afterService),discount:t(s.discountAmount),afterDiscount:t(s.afterDiscount),gst:t(s.gst)},paymentInfo:{originalAmount:r?t(i):null,amount:t(i,!0),phoneNumber:e.paynowID||"",name:e.paynowName||"",settleMatter:e.settleMatter||"",uen:"N/A"}}}),payerName&&!e.members.some(e=>e.name===payerName)&&(memberData[payerName]={totalAmount:"$0.00",items:[],breakdown:{subtotal:"$0.00",serviceCharge:"$0.00",afterService:"$0.00",discount:"$0.00",afterDiscount:"$0.00",gst:"$0.00"},discount:e.discount||"",serviceChargeRate:e.serviceChargeRate||"10%",gstRate:e.gstRate||"9%",taxProfile:e.taxProfile||"singapore",paymentInfo:{originalAmount:null,amount:"$0.00",phoneNumber:e.paynowID||"",name:e.paynowName||"",settleMatter:e.settleMatter||"",uen:"N/A"}})}function updateGroupMembers(e){const t=document.getElementById("groupMembers");if(!t)return;t.innerHTML="";const n=document.querySelector(".favourite-group-section");n&&(n.style.opacity="0");let a=e.length;function s(){if(a--,0===a&&n){n.style.opacity="1",n.style.transition="opacity 0.5s ease";const e=document.getElementById("bill-content"),t=document.getElementById("bill-content");e&&(e.classList.add("visible"),setTimeout(()=>{t&&t.classList.add("ready")},4500));const a=document.getElementById("loading");a.classList.add("fade-out"),a.classList.add("hidden"),setTimeout(()=>{refreshAllPaymentStatuses()},500),setTimeout(()=>{checkPaymentCompletion()&&showCompletionCelebration()},1500)}}e.forEach((e,n)=>{const a=document.createElement("div");a.className="member-avatar-wrapper",a.setAttribute("data-name",e.name);const o=.4+.2*n;a.style.animation=`fadeInUp 0.4s ${o}s ease forwards`;const i=e.avatar||Math.floor(9*Math.random())+1,r=paymentStatus[e.name]?.hasPaid||!1,l=billData?.birthdayPerson===e.name;a.innerHTML=`\n      <div class="member-avatar ${r?"paid":""} ${l?"birthday-person":""}">\n        <img src="/assets/cat-icon/cat-${i}.svg" alt="Cat avatar" class="cat-avatar-img" />\n        ${r?'<div class="paid-indicator">‚úì</div><span class="paid-label">Paid</span>':""}\n      </div>\n      <div class="member-name ${l?"birthday-person":""}">${e.name===payerName?"üí∏ ":""}${l?"üéÇ ":""}${e.name}</div>\n    `;const d=new Image;d.onload=s,d.onerror=s,d.src=`/assets/cat-icon/cat-${i}.svg`,a.addEventListener("click",function(){showShareModal(e.name)}),t.appendChild(a)})}function showError(e,t="generic"){const n=document.getElementById("loading");n.classList.add("fade-out"),setTimeout(()=>{n.classList.add("hidden");document.getElementById("error-message").textContent=e;const a=document.getElementById("error-retry-btn");"expired"===t||"invalid"===t?(a.textContent="Return to Home",a.onclick=()=>window.location.href="/"):(a.textContent="Try Again",a.onclick=()=>window.location.reload());document.getElementById("error-container").classList.add("visible");const s=document.getElementById("bill-content"),o=document.getElementById("bill-content-footer");s&&s.classList.contains("visible")&&s.classList.remove("visible"),o&&o.classList.contains("visible")&&o.classList.remove("visible")},300)}function isRunningAsPWA(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone}function handleShareBill(){const e=window.location.href,t=document.querySelector(".successSettleMatter")?.textContent||"SettleLah Bill",n={title:`SettleLah! - ${t}`,text:`SettleLah! about ${t}`,url:e};navigator.share&&navigator.canShare&&navigator.canShare(n)?navigator.share(n).then(()=>{showToast("Bill shared successfully!")}).catch(t=>{"AbortError"!==t.name&&copyToClipboard(e)}):copyToClipboard(e)}function copyToClipboard(e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{showToast("Bill URL copied to clipboard!")}).catch(()=>{fallbackCopyToClipboard(e)}):fallbackCopyToClipboard(e)}function fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),showToast("Bill URL copied to clipboard!")}catch(e){showToast("Unable to copy URL. Please copy manually.")}finally{document.body.removeChild(t)}}function showToast(e){const t=document.querySelector(".toast-notification");t&&t.remove();const n=document.createElement("div");n.textContent=e,n.className="toast-notification",document.body.appendChild(n),setTimeout(()=>{n.classList.add("toast-fadeout"),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},500)},2500)}document.addEventListener("DOMContentLoaded",function(){document.getElementById("error-container").classList.remove("visible"),document.getElementById("loading").classList.remove("hidden");const e=window.location.pathname.split("/");if(billId=e[e.length-1],!billId)return void showError("No bill ID found in URL","invalid");if(!/^[a-z0-9]+-[a-z0-9]+-[a-z0-9]+$/i.test(billId))return void showError("Invalid bill ID format","invalid");fetch(`/result/${billId}`,{headers:{Accept:"application/json"}}).then(e=>{if(410===e.status)throw new Error("This bill has expired",{cause:"expired"});if(400===e.status)throw new Error("Invalid bill ID format",{cause:"invalid"});if(!e.ok)throw new Error("Bill not found or error fetching data");return e.json()}).then(e=>{setTimeout(()=>{renderBillData(e)},300)}).catch(e=>{const t=e.cause||"generic";showError(e.message,t)});const t=document.querySelectorAll(".member-avatar-wrapper"),n=document.querySelector(".drag-instructions");n&&n.classList.remove("animate-pulse"),t.forEach(e=>{e.addEventListener("click",function(){showShareModal(this.getAttribute("data-name"))})});const a=document.getElementById("share-bill-btn");a&&a.addEventListener("click",handleShareBill)}),window.onload=function(){const e=document.querySelector(".terminal-img"),t=document.querySelector(".terminal-img-top"),n=document.getElementById("successReceipt"),a=document.querySelector(".favourite-group-section"),s=document.querySelector(".success-footer-text-title"),o=document.querySelector(".settings-footer");n&&(n.style.animation="receipt 3s ease both"),e&&(e.style.animation="slideup 0.5s 4s ease both"),t&&(t.style.animation="slideup 0.5s 4s ease both"),a&&(a.style.opacity="1"),s&&(s.style.animation="fadeInUp 0.5s 0.2s ease forwards"),o&&(o.style.animation="fadeInUp 0.5s 0.4s ease forwards");document.querySelectorAll(".member-avatar-wrapper").forEach((e,t)=>{e.style.animation=`fadeInUp 0.4s ${.4+.2*t}s ease forwards`})},document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".copyrightYear");e&&(e.textContent=(new Date).getFullYear())}),window.onload=function(){isRunningAsPWA()&&(document.body.style.height="100vh")};
>>>>>>> origin/main
