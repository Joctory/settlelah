function isRunningAsPWA(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("copyrightYear").textContent=(new Date).getFullYear(),document.addEventListener("touchstart",function(e){e.touches.length>1&&(e.preventDefault(),e.stopPropagation())},{passive:!1}),document.addEventListener("gesturestart",function(e){e.preventDefault()},{passive:!1});let e="";const t=document.querySelectorAll(".passcode-dot"),s=document.getElementById("login-error"),a=document.getElementById("loginEmail"),n=document.getElementById("email-error"),i=document.getElementById("continueBtn"),o=document.querySelector(".auth-step-email"),l=document.querySelector(".auth-step-passcode"),r=document.getElementById("displayedEmail"),c=document.getElementById("changeEmailBtn");function d(){const e=a.value.trim();if(!L(e))return void E("Please enter a valid email address");i.disabled=!0;const s=i.textContent;i.textContent="Verifying...",fetch("/api/verify-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})}).then(e=>423===e.status?e.json().then(e=>{throw new Error(JSON.stringify({locked:!0,code:e.code,message:e.error,remainingMinutes:e.remainingMinutes}))}):e.json()).then(a=>{i.disabled=!1,i.textContent=s,a.valid?function(e){r.textContent=e,document.querySelector(".login-subtitle").textContent="Enter your 6-digit passcode",o.classList.remove("active"),setTimeout(()=>{l.style.display="flex",l.offsetWidth,l.classList.add("active"),t.forEach((e,t)=>{setTimeout(()=>{e.classList.add("bounce"),setTimeout(()=>e.classList.remove("bounce"),400)},100+60*t)}),document.querySelectorAll(".keypad-key").forEach((e,t)=>{e.style.opacity="0",e.style.transform="translateY(8px)",setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},300+40*t)}),S()},250)}(e):E(a.message||"Invalid email or passcode. Please try again.")}).catch(e=>{i.disabled=!1,i.textContent=s;try{const t=JSON.parse(e.message);if(t.locked){let e=t.message;return t.remainingMinutes&&(e+=` Try again in ${t.remainingMinutes} minutes.`),E(e),a.disabled=!0,i.disabled=!0,void(t.remainingMinutes&&setTimeout(()=>{a.disabled=!1,i.disabled=!1,S()},60*t.remainingMinutes*1e3))}}catch(e){}E("Connection error. Please try again.")})}function u(){l.classList.remove("active"),setTimeout(()=>{l.style.display="none",o.classList.add("active"),a.disabled=!1,i.disabled=!1,i.textContent="Continue",a.focus(),document.querySelector(".login-subtitle").textContent="Enter your email to continue",f()},300)}l.style.display="none",l.style.opacity="0",a.addEventListener("input",function(){const e=a.value.trim();i.disabled=!L(e),""===e||L(e)?(a.classList.remove("invalid-email"),L(e)?a.classList.add("valid-email"):a.classList.remove("valid-email")):(a.classList.add("invalid-email"),a.classList.remove("valid-email"))}),a.addEventListener("blur",function(){const e=a.value.trim();""===e||L(e)?S():E("Please enter a valid email address")}),a.addEventListener("keydown",function(e){"Enter"===e.key&&L(a.value.trim())&&d()}),i.addEventListener("click",d),c.addEventListener("click",u);const m=new URLSearchParams(window.location.search).get("registered");if(m&&"true"===m.toLowerCase()&&m.length<=4){!function(e,t){let s=document.querySelector(".login-message");if(!s){s=document.createElement("div"),s.classList.add("login-message");const e=document.querySelector(".login-container");e.insertBefore(s,e.firstChild)}s.textContent=e,s.className="login-message","success"===t?s.classList.add("success"):"error"===t&&s.classList.add("error");s.style.display="block",setTimeout(()=>{s.style.opacity="0",setTimeout(()=>{s.style.display="none"},300)},5e3)}("Registration successful! Please log in with your email and passcode.","success");const e=new URL(window.location);e.searchParams.delete("registered"),window.history.replaceState({},document.title,e.toString())}function y(e){navigator.vibrate&&navigator.vibrate(e)}const g=document.getElementById("preloader");g&&setTimeout(()=>{g.classList.add("fade-out"),setTimeout(()=>{g.style.display="none"},500)},800),function(){const e="true"===localStorage.getItem("settlelah_authenticated"),t=parseInt(localStorage.getItem("settlelah_auth_expiry")||"0");e&&t>Date.now()&&(window.location.href="/")}();function v(s){if(e.length>=6)return;S(),e+=s;const a=t[e.length-1];a&&(a.classList.add("filled"),a.classList.add("bounce"),setTimeout(()=>a.classList.remove("bounce"),300)),6===e.length&&setTimeout(p,300)}function h(){if(e.length>0){const s=t[e.length-1];s&&s.classList.remove("filled"),e=e.slice(0,-1),S()}}function f(){e="",t.forEach(e=>e.classList.remove("filled")),S()}function p(){const s=r.textContent;if(!L(s))return u(),void E("Please enter a valid email address");t.forEach(e=>{e.classList.contains("filled")&&e.classList.add("pulse")}),fetch("/api/validate-passcode",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,passcode:e})}).then(e=>429===e.status?e.json().then(e=>{throw new Error(e.error||"Too many attempts. Please try again later.")}):e.json()).then(e=>{if(t.forEach(e=>e.classList.remove("pulse")),e.valid)e.userId&&localStorage.setItem("settlelah_user_id",e.userId),e.name&&localStorage.setItem("settlelah_user_name",e.name),e.email&&localStorage.setItem("settlelah_user_email",e.email),e.accessToken&&localStorage.setItem("settlelah_access_token",e.accessToken),e.refreshToken&&localStorage.setItem("settlelah_refresh_token",e.refreshToken),e.token&&!e.accessToken&&localStorage.setItem("settlelah_user_token",e.token),function(){t.forEach(e=>{e.classList.add("success")}),localStorage.setItem("settlelah_authenticated","true");const e=Date.now()+1296e6;localStorage.setItem("settlelah_auth_expiry",e.toString()),setTimeout(()=>{window.location.href="/"},800)}();else{let t=e.message||"Invalid email or passcode. Please try again.";void 0!==e.remainingAttempts&&(0===e.remainingAttempts?t="Account locked due to too many failed attempts. Please try again in 15 minutes.":t+=` (${e.remainingAttempts} attempts remaining)`),("ACCOUNT_LOCKED"===e.code||"IP_LOCKED"===e.code)&&(t=e.error,e.remainingMinutes&&(t+=` Try again in ${e.remainingMinutes} minutes.`)),k(t)}}).catch(e=>{console.error("Authentication error:",e),t.forEach(e=>e.classList.remove("pulse")),k("Authentication failed. Please try again.")})}function L(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function E(e){n.textContent=e,n.classList.add("visible"),a.style.borderColor="var(--error-color)",a.classList.add("invalid-email"),a.classList.remove("valid-email"),y([50,50,50])}function k(a){y([100,50,100,50,100]);const n=document.querySelector(".passcode-dots");n.classList.add("shake"),setTimeout(()=>{e="",t.forEach(e=>e.classList.remove("filled")),n.classList.remove("shake"),function(e){s.textContent=e,s.classList.add("visible")}(a)},600)}function S(){s.classList.remove("visible"),n.classList.remove("visible"),a.style.borderColor="",a.classList.remove("invalid-email")}document.querySelectorAll(".keypad-key").forEach(e=>{const t=t=>{t.preventDefault();const s=e.getAttribute("data-value"),a=e.getAttribute("data-action");e.classList.add("pressed"),y(10),s?v(s):"delete"===a?h():"clear"===a&&f(),setTimeout(()=>{e.classList.remove("pressed")},80)};e.addEventListener("touchstart",t,{passive:!1}),e.addEventListener("click",e=>{e.defaultPrevented||t(e)}),e.addEventListener("touchend",()=>e.classList.remove("pressed")),e.addEventListener("touchcancel",()=>e.classList.remove("pressed"))}),document.addEventListener("keydown",t=>{if(l.classList.contains("active"))if(t.key>="0"&&t.key<="9"){const e=document.querySelector(`.keypad-key[data-value="${t.key}"]`);e&&(e.classList.add("pressed"),setTimeout(()=>e.classList.remove("pressed"),80)),v(t.key)}else if("Backspace"===t.key){const e=document.querySelector('.keypad-key[data-action="delete"]');e&&(e.classList.add("pressed"),setTimeout(()=>e.classList.remove("pressed"),80)),h()}else if("Escape"===t.key){const e=document.querySelector('.keypad-key[data-action="clear"]');e&&(e.classList.add("pressed"),setTimeout(()=>e.classList.remove("pressed"),80)),f()}else"Enter"===t.key&&6===e.length&&p()})}),window.onload=function(){isRunningAsPWA()&&(document.body.style.height="100vh",document.documentElement.style.height="100vh")};